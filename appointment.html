<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="q6qnX2SH5llFty6Oy1rgN5_49L_ChMSuhR4jn8mZJNE" />
  <title>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Required Libraries for PDF/PNG Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background: linear-gradient(135deg, #f0f8ff, #e1f5fe);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 640px;
      margin: 20px auto;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }
    
    .header {
      background: var(--primary);
      color: var(--white);
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .header h2 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .header::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      right: 0;
      height: 20px;
      background: var(--white);
      clip-path: ellipse(50% 50% at 50% 50%);
    }
    
    form {
      padding: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .input-field {
      position: relative;
    }

    .age-multiple-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶ï‡¶≤‡¶æ‡¶Æ */
  gap: 15px;
  align-items: stretch;
}

.age-single-field {
  display: flex;
  flex-direction: column;
}

.age-input-group {
  display: flex;
  flex-direction: column;
}
    
    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Noto Sans Bengali', sans-serif;
      transition: all 0.2s ease;
      background-color: var(--white);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    input::placeholder {
      color: var(--gray);
      opacity: 0.6;
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    .info-text {
      color: var(--gray);
      font-size: 13px;
      margin-top: 5px;
      display: block;
    }
    
    .no-slots-message {
      background-color: #fef3c7;
      color: var(--warning);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    
    .no-day-message {
      background-color: #fef3c7;
      color: var(--warning);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    
    .loading-message {
      background-color: #dbeafe;
      color: var(--primary);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 15px;
      display: none;
    }

    /* Custom Popup Modal */
    .popup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: popupIn 0.3s ease-out;
    }

    @keyframes popupIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .popup-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .popup-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .popup-message {
      font-size: 16px;
      margin-bottom: 20px;
      color: #6b7280;
      line-height: 1.5;
      text-align: left;
    }

    .popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .popup-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .popup-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .popup-btn.cancel {
      background: var(--gray);
    }

    .popup-btn.cancel:hover {
      background: #4b5563;
    }

    .popup-btn.success {
      background: var(--success);
    }

    .popup-btn.success:hover {
      background: #15803d;
    }

    .popup-btn.warning {
      background: var(--warning);
    }

    .popup-btn.warning:hover {
      background: #d97706;
    }

    /* Fixed Super Compact Slip - No Scroll, All Devices Friendly */
       .confirmation-slip {
    background: white;
    border: 2px solid #2563eb;
    border-radius: 10px;
    padding: 15px;
    margin: 15px auto; /* üî• auto margin for centering */
    text-align: center;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    max-width: 300px;
    width: 100%; /* üî• Full width of parent */
    
    /* üî• Center alignment */
    display: block;
    margin-left: auto;
    margin-right: auto;
    
    /* üî• Prevent overflow */
    box-sizing: border-box;
    overflow: hidden;
}

    .slip-header {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 8px;
        margin-bottom: 10px;
    }

    .slip-header h3 {
        color: #2563eb;
        font-size: 14px;
        margin-bottom: 3px;
        font-weight: 700;
    }

    .slip-header p {
        color: #6b7280;
        font-size: 12px;
        margin: 0;
    }

    .slip-details {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 12px;
        font-size: 12px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-label {
        font-weight: 600;
        color: #374151;
        text-align: left;
        flex: 1;
        min-width: 60px;
    }

    .detail-value {
        color: #1f2937;
        text-align: right;
        flex: 1;
        font-weight: 500;
        min-width: 100px;
    }

    .serial-number {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 20px;
        font-weight: 700;
        border: 2px solid #3b82f6;
    }

    .slip-footer {
        border-top: 1px solid #e5e7eb;
        padding-top: 8px;
        color: #6b7280;
        font-size: 10px;
        line-height: 1.3;
        margin-top: 8px;
    }

    /* Download Buttons CSS */
    .download-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .download-btn {
        background: #16a34a;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 120px;
        justify-content: center;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .download-btn:hover {
        background: #15803d;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .download-btn.pdf {
        background: #dc2626;
    }

    .download-btn.pdf:hover {
        background: #b91c1c;
    }

    /* Mobile First Design for Slip */
    @media (max-width: 480px) {
        .confirmation-slip {
            max-width: 100%;
            padding: 12px;
        }
        
        .slip-details {
            gap: 4px;
            font-size: 11px;
        }
        
        .detail-item {
            padding: 2px 0;
        }
        
        .serial-number {
            font-size: 18px;
            padding: 10px;
        }
        
        .slip-footer {
            font-size: 9px;
            padding-top: 6px;
            margin-top: 6px;
        }
        
        .download-buttons {
            flex-direction: column;
            gap: 6px;
        }
        
        .download-btn {
            min-width: 100%;
            padding: 10px;
            font-size: 13px;
        }
    }

    /* Serial Selection Section */
    .serial-section {
      margin-top: 30px;
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
    }
    
    .serial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .serial-header h3 {
      font-size: 18px;
      color: #1f2937;
    }
    
    .legend {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 14px;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.2s ease;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .submit-btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
    }
    
    .submit-btn:active {
      transform: translateY(0);
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .success-message {
      background-color: #dcfce7;
      color: var(--success);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .helpline {
    /* ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ï‡ßá DIV ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá */
    text-align: center; 
    
    /* ‡¶â‡¶™‡¶∞ ‡¶•‡ßá‡¶ï‡ßá 20 ‡¶™‡¶ø‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ‡¶æ‡¶¨‡ßá (‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶Æ‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®) */
    padding-top: 20px; 
    
    /* ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø DIV ‡¶ï‡ßá ‡¶Ö‡¶®‡ßÅ‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá (horizontally) ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• (width) ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§ ‡¶Ø‡¶¶‡¶ø‡¶ì text-align ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ï‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü‡•§ */
    /* width: 50%; */
    /* margin: 0 auto; */
}

/* ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶≠‡ßá‡¶§‡¶∞‡ßá‡¶∞ LABEL ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶ì ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶§‡¶¨‡ßá ‡¶è‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® */
.helpline label {
    /* ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá */
    /* font-size: 16px; */
    /* color: #333; */
}
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .container {
        margin: 10px auto;
        border-radius: 0;
      }
      
      form {
        padding: 20px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
        gap: 8px;
      }
      
      .legend {
        flex-direction: column;
        gap: 8px;
      }

      .popup-content {
        padding: 20px;
        margin: 20px;
      }

      .slip-details {
        grid-template-columns: 1fr;
      }

      .popup-buttons {
        flex-direction: column;
      }

      .download-buttons {
        flex-direction: column;
      }
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
      animation: fadeIn 0.3s ease forwards;
    }
    
    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.2s; }
    .form-group:nth-child(3) { animation-delay: 0.3s; }
    .form-group:nth-child(4) { animation-delay: 0.4s; }
    .form-group:nth-child(5) { animation-delay: 0.5s; }
    .form-group:nth-child(6) { animation-delay: 0.6s; }
    .serial-section { animation: fadeIn 0.3s ease 0.7s forwards; opacity: 0; }
  </style>
</head>
<body>
  </header>
  <!-- Unified Popup Modal -->
  <div class="popup-modal" id="universalPopup">
    <div class="popup-content">
      <div class="popup-icon" id="popupIcon">‚ö†Ô∏è</div>
      <div class="popup-title" id="popupTitle">‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</div>
      <div class="popup-message" id="popupMessage">
        ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá
      </div>
      <!-- Confirmation Slip for Download -->
      <div class="confirmation-slip" id="confirmationSlip" style="display: none;">
        <div class="slip-header">
          <h3>üè• ‡¶°‡¶æ‡¶É ‡¶Æ‡ßã‡¶É ‡¶ì‡¶Ø‡¶º‡¶æ‡¶π‡¶ø‡¶¶‡ßÅ‡¶ú‡ßç‡¶ú‡¶æ‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶æ‡¶∏‡ßÅ‡¶Æ</h3>
          <p>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶≤‡¶ø‡¶™</p>
        </div>
        <div class="slip-details">
          <div class="detail-item">
            <div class="detail-label">‡¶®‡¶æ‡¶Æ:</div>
            <div class="detail-value" id="slipName">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶¨‡ßü‡¶∏:</div>
            <div class="detail-value" id="slipAge">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶´‡ßã‡¶®:</div>
            <div class="detail-value" id="slipPhone">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶ß‡¶∞‡¶®:</div>
            <div class="detail-value" id="slipType">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶¶‡¶ø‡¶®:</div>
            <div class="detail-value" id="slipDay">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶∏‡¶Æ‡ßü:</div>
            <div class="detail-value" id="slipTime">-</div>
          </div>
        </div>
        <div class="serial-number" id="slipSerial">#‡ß¶</div>
        <div class="slip-footer">
          ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡ßü: <span id="slipDateTime">-</span> | ‡¶è‡¶á ‡¶∏‡ßç‡¶≤‡¶ø‡¶™‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶∏‡¶æ‡¶•‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡ßÅ‡¶®
        </div>
      </div>
      <div class="popup-buttons" id="popupButtons">
        <button class="popup-btn cancel" onclick="closePopup()">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
      <!-- Download Buttons for Confirmation Slip -->
      <div class="download-buttons" id="downloadButtons" style="display: none;">
        <button class="download-btn" onclick="downloadPNG()">
          üì∏ PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        </button>
        <button class="download-btn pdf" onclick="downloadPDF()">
          üìÑ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        </button>
      </div>
    </div>
  </div>

  <!-- Appointment Form -->
  <div class="container">
    <div class="header">
      <h2> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</h2>
    </div>
    
    <form id="appointmentForm" novalidate>
      <div class="form-group">
        <label for="name">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
        <div class="input-field">
          <input type="text" id="name" name="name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required
            pattern="[a-zA-Z\u0980-\u09FF\.\s]{3,50}" 
            title="‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ/‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞, ‡¶°‡¶ü (.) ‡¶ì ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (3-50 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)">
        </div>
        <small id="nameError" class="error-msg">‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ)</small>
      </div>

      <div class="form-group">
  <label for="age">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶¨‡¶Ø‡¶º‡¶∏</label>
  
  <div class="age-multiple-container">
    
    <div class="age-single-field">
      <div class="age-input-group">
        <input type="number" 
               id="ageYears" 
               name="ageYears" 
               placeholder="‡¶¨‡¶õ‡¶∞"
               min="0"
               max="120"
               oninput="normalizeAgeInputs()">
      </div>
    </div>
    
    <div class="age-single-field">
      <div class="age-input-group">
        <input type="number" 
               id="ageMonths" 
               name="ageMonths" 
               placeholder="‡¶Æ‡¶æ‡¶∏"
               min="0"
               oninput="normalizeAgeInputs()">
      </div>
    </div>
    
    <div class="age-single-field">
      <div class="age-input-group">
        <input type="number" 
               id="ageDays" 
               name="ageDays" 
               placeholder="‡¶¶‡¶ø‡¶®"
               min="0"
               oninput="normalizeAgeInputs()">
      </div>
    </div>
    
  </div>
  
  <small id="ageError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡ßü‡¶∏ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
  <small class="info-text">‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡¶õ‡¶∞/‡¶Æ‡¶æ‡¶∏/‡¶¶‡¶ø‡¶®)</small>
</div>

      <div class="form-group">
        <label for="phone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
        <div class="input-field">
          <input type="tel" id="phone" name="phone" placeholder="01XXXXXXXXX" required pattern="01[0-9]{9}"
            title="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>
        <small id="phoneError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (01XXXXXXXXX)</small>
        <small class="info-text">‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨</small>
      </div>

      <div class="form-group">
        <label for="patientType">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ß‡¶∞‡¶®</label>
        <div class="input-field">
          <select id="patientType" name="patientType" required>
            <option value="">-- ‡¶ß‡¶∞‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
            <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
          </select>
          <small class="info-text">‡ß¶-‡ßØ‡ß¶ ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ó‡¶£‡ßç‡¶Ø ‡¶π‡¶¨‡ßá</small>
        </div>
      </div>

      <div class="form-group">
        <label for="day">‡¶¶‡¶ø‡¶®</label>
        <div class="input-field">
          <select id="day" name="day" required>
            <option value="">-- ‡¶¶‡¶ø‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="time">‡¶∏‡¶Æ‡ßü</label>
        <div class="input-field">
          <select id="time" name="time" required disabled>
            <option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
          </select>
          <small class="info-text">‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶Ø‡¶º</small>
        </div>
      </div>

      <!-- Hidden messages (kept for backup) -->
      <div class="no-day-message" id="noDayMessage" style="display: none;">
        ‚ö†Ô∏è ‡¶è‡¶á ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡ß¶‡ßß‡ß≠‡ß≠‡ß≠‡ßÆ‡ßÆ‡ßÆ‡ß™‡ßÆ‡ßØ ‡¶ï‡¶∞‡ßÅ‡¶® ‡•§
      </div>

      <div class="serial-section">
        <div class="serial-header">
          <h3>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot available-dot"></span>
              <span>‡¶ñ‡¶æ‡¶≤‡¶ø</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot pending-dot"></span>
              <span>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° (‡¶Ö‡¶®‡ßç‡¶Ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot selected-dot"></span>
              <span>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot booked-dot"></span>
              <span>‡¶¨‡ßÅ‡¶ï‡¶°</span>
            </div>
          </div>
        </div>
        
        <div class="loading-message" id="loadingMessage">
          üîÑ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </div>
        
        <div class="serial-grid" id="serialGrid">
          <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
        </div>
        
        <!-- Hidden no slots message -->
        <div class="no-slots-message" id="noSlotsMessage" style="display: none;">
          ‚ö†Ô∏è ‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Æ‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
        </div>
        
        <input type="hidden" name="serial" id="serialInput" required>
        <small id="serialError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</small>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      
      <!-- Hidden success message -->
      <div class="success-message" id="successMessage" style="display: none;">
        ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!
      </div>
      <div class="helpline">
      <label for="day">‡¶π‡ßá‡¶≤‡ßç‡¶™ ‡¶≤‡¶æ‡¶á‡¶® ‡ß¶‡ßß‡ß≠‡ß≠‡ß≠‡ßÆ‡ßÆ‡ßÆ‡ß™‡ßÆ‡ßØ</label>
      </div>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

   <!-- ‡ß®. grid.js ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø -->
  <script src="grid.js"></script>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    // Global db variable
    let db;

    // Firebase initialization with better error handling
    function initializeFirebase() {
      try {
        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully in appointment form");
        return true;
      } catch (error) {
        console.error("‚ùå Firebase initialization error in appointment form:", error);
        return false;
      }
    }

    // Initialize Firebase immediately
    initializeFirebase();

    // ==================== APP CONSTANTS AND VARIABLES ====================
    let serialRanges = {};
    let appointments = [];
    let realtimeListeners = [];
    let currentUserSelection = null;
    let currentUserPendingId = null;
    let currentAppointmentData = null;
    let skipNoAvailabilityPopup = false;

    // DOM Elements
    const daySelect = document.getElementById('day');
    const typeSelect = document.getElementById('patientType');
    const timeSelect = document.getElementById('time');
    const serialGrid = document.getElementById('serialGrid');
    const serialInput = document.getElementById('serialInput');
    const nameInput = document.getElementById('name');
    const nameError = document.getElementById('nameError');
    const ageYearsInput = document.getElementById('ageYears');
    const ageMonthsInput = document.getElementById('ageMonths');
    const ageDaysInput = document.getElementById('ageDays');
    const ageError = document.getElementById('ageError');
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phoneError');
    const serialError = document.getElementById('serialError');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const noSlotsMessage = document.getElementById('noSlotsMessage');
    const noDayMessage = document.getElementById('noDayMessage');
    const loadingMessage = document.getElementById('loadingMessage');

    // Popup Elements
    const universalPopup = document.getElementById('universalPopup');
    const popupIcon = document.getElementById('popupIcon');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const popupButtons = document.getElementById('popupButtons');
    const confirmationSlip = document.getElementById('confirmationSlip');
    const downloadButtons = document.getElementById('downloadButtons');

    // Slip Elements
    const slipName = document.getElementById('slipName');
    const slipAge = document.getElementById('slipAge');
    const slipPhone = document.getElementById('slipPhone');
    const slipType = document.getElementById('slipType');
    const slipDay = document.getElementById('slipDay');
    const slipTime = document.getElementById('slipTime');
    const slipSerial = document.getElementById('slipSerial');
    const slipDateTime = document.getElementById('slipDateTime');

    // ==================== GRID SYSTEM ====================
    let gridSystem = null;

    function initializeGridSystem() {
      if (!db) {
        console.error('Database not available for grid system');
        return;
      }

      gridSystem = new RealTimeGridSystem({
        db: db,
        gridContainerId: 'serialGrid',
        selectedSerialInputId: 'serialInput',
        dayElementId: 'day',
        timeElementId: 'time',
        typeElementId: 'patientType',
        mode: 'user',
        
        // Custom callbacks
        onSerialClick: function(data) {
          console.log('Serial clicked:', data);
          
          if (data.status === 'booked') {
            showPopup('error', '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¨‡ßÅ‡¶ï‡¶°', '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
          } else if (data.status === 'pending') {
            // Serial selected successfully
            serialInput.value = data.serial;
            serialError.style.display = 'none';
            currentUserPendingId = data.pendingId;
            currentUserSelection = data.serial;
          }
        },
        
        onGridUpdate: function(type, data) {
          console.log('Grid updated:', type);
          
          if (type === 'grid') {
            loadingMessage.style.display = 'none';
            
            // Check if no available serials
            const availableSerials = gridSystem.getAvailableSerials();
            if (availableSerials.length === 0) {
              noSlotsMessage.style.display = 'block';
            } else {
              noSlotsMessage.style.display = 'none';
            }
          }
        },
        
        onPendingUpdate: function(pendingData) {
          console.log('Pending updated:', pendingData);
        }
      });
      
      // Initialize grid system
      gridSystem.init().then(success => {
        if (success) {
          console.log('‚úÖ Grid System initialized successfully');
        }
      });
    }

    // ‚úÖ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® - FIXED
    function extractTimeNumber(timeStr) {
      if (!timeStr) return 0;
      
      const time = timeStr.toUpperCase().trim();
      let [timePart, modifier] = time.split(' ');
      
      // ‡¶Ø‡¶¶‡¶ø AM/PM ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
      if (!modifier) {
        modifier = time.includes('PM') ? 'PM' : time.includes('AM') ? 'AM' : '';
        if (modifier) {
          timePart = time.replace(modifier, '').trim();
        }
      }
      
      const [hours, minutes] = timePart.split(':').map(Number);
      
      // Convert to 24-hour format for proper sorting
      let hour24 = hours;
      
      if (modifier === 'PM' && hours !== 12) {
        hour24 = hours + 12;
      } else if (modifier === 'AM' && hours === 12) {
        hour24 = 0;
      }
      
      return hour24 * 100 + (minutes || 0);
    }

    // ‚úÖ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° updateTimeOptions ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® - 12:00 AM ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá, 12:00 PM ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá
    function updateTimeOptions() {
      const day = daySelect.value;
      const type = typeSelect.value;
      
      console.log('üïí Updating time options for:', day, type);
      
      timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
      serialGrid.innerHTML = '';
      serialInput.value = '';
      noSlotsMessage.style.display = 'none';
      currentUserSelection = null;

      let hasTimeSlots = false;
      let timeSlots = [];

      if(day && type && serialRanges[day] && serialRanges[day][type]) {
        timeSlots = Object.keys(serialRanges[day][type]);
        console.log('‚è∞ Available times:', timeSlots);
        
        if (timeSlots.length > 0) {
          hasTimeSlots = true;
          
          // ‚úÖ ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã - FIXED
          const sortedTimes = timeSlots.sort((a, b) => {
            const numA = extractTimeNumber(a);
            const numB = extractTimeNumber(b);
            
            return numA - numB;
          });
          
          console.log('üïí Sorted times:', sortedTimes);
          
          // ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶™‡¶∂‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
          sortedTimes.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
          });
        }
      }

      // Show popup if no time slots available
      if (!hasTimeSlots) {
        const dayText = day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
        const typeText = type === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
        
        const message = `"${dayText}" ‡¶è‡¶¨‡¶Ç "${typeText}" ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßü ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ ‡¶ß‡¶∞‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
        
        showPopup('warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßü ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á', message);
        
        timeSelect.innerHTML = '<option value="">-- ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßü ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á --</option>';
        console.log('‚è∞ No times available for:', day, type);
      }
    }

    function normalizeAgeInputs() {
      let years = parseInt(ageYearsInput.value) || 0;
      let months = parseInt(ageMonthsInput.value) || 0;
      let days = parseInt(ageDaysInput.value) || 0;
      
      const original = { years, months, days };
      
      // ================================
      // ‡ßß. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶Æ‡¶æ‡¶® ‡¶§‡ßà‡¶∞‡¶ø
      // ================================
      let dbYears = years;
      let dbMonths = months;
      let dbDays = days;
      
      // ‡¶Æ‡¶æ‡¶∏ > 12 ‡¶π‡¶≤‡ßá ‡¶¨‡¶õ‡¶∞‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
      if (dbMonths >= 12) {
        dbYears += Math.floor(dbMonths / 12);
        dbMonths = dbMonths % 12;
      }
      
      // ‡¶¶‡¶ø‡¶® > 30 ‡¶π‡¶≤‡ßá ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
      if (dbDays >= 30) {
        dbMonths += Math.floor(dbDays / 30);
        dbDays = dbDays % 30;
        
        // ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡¶æ‡¶∏ ‡ßß‡ß® ‡¶¨‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü
        if (dbMonths >= 12) {
          dbYears += Math.floor(dbMonths / 12);
          dbMonths = dbMonths % 12;
        }
      }
      
      // ================================
      // ‡ß®. ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï (‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶Æ‡¶æ‡¶®‡ßá)
      // ================================
      const MAX_YEARS = 120;
      let isValid = true;
      let errorMessage = '';
      
      if (years < 0 || months < 0 || days < 0) {
        isValid = false;
        errorMessage = '‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶ã‡¶£‡¶æ‡¶§‡ßç‡¶Æ‡¶ï ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶®‡¶æ';
      } else if (years === 0 && months === 0 && days === 0) {
        isValid = false;
        errorMessage = '‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßß ‡¶¶‡¶ø‡¶® ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá';
      } else if (dbYears > MAX_YEARS) {
        isValid = false;
        errorMessage = '‡¶¨‡¶Ø‡¶º‡¶∏ ‡ßß‡ß®‡ß¶ ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶®‡¶æ';
      }
      
      // ================================
      // ‡ß©. ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
      // ================================
      if (!isValid) {
        ageError.style.display = 'block';
        ageError.textContent = errorMessage;
      } else {
        ageError.style.display = 'none';
      }
      
      const result = { 
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
        inputYears: years,
        inputMonths: months,
        inputDays: days,
        
        // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶°
        dbYears: dbYears,
        dbMonths: dbMonths,
        dbDays: dbDays,
        
        isValid: isValid
      };
      
      return result;
    }

    function getAgeData() {
      // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá normalize ‡¶ï‡¶∞‡ßÅ‡¶®
      const normalized = normalizeAgeInputs();
      
      // ================================
      // ‡ßß. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
      // ================================
      const inputParts = [];
      if (normalized.inputYears > 0) inputParts.push(`${normalized.inputYears} ‡¶¨‡¶õ‡¶∞`);
      if (normalized.inputMonths > 0) inputParts.push(`${normalized.inputMonths} ‡¶Æ‡¶æ‡¶∏`);
      if (normalized.inputDays > 0) inputParts.push(`${normalized.inputDays} ‡¶¶‡¶ø‡¶®`);
      
      const inputText = inputParts.join(' ') || '‡ß¶ ‡¶¨‡¶õ‡¶∞ ‡ß¶ ‡¶Æ‡¶æ‡¶∏ ‡ß¶ ‡¶¶‡¶ø‡¶®';
      
      // ================================
      // ‡ß®. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú/‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
      // ================================
      const displayParts = [];
      if (normalized.dbYears > 0) displayParts.push(`${normalized.dbYears} ‡¶¨‡¶õ‡¶∞`);
      if (normalized.dbMonths > 0) displayParts.push(`${normalized.dbMonths} ‡¶Æ‡¶æ‡¶∏`);
      if (normalized.dbDays > 0) displayParts.push(`${normalized.dbDays} ‡¶¶‡¶ø‡¶®`);
      
      const displayText = displayParts.join(' ') || '‡ß¶ ‡¶¨‡¶õ‡¶∞ ‡ß¶ ‡¶Æ‡¶æ‡¶∏ ‡ß¶ ‡¶¶‡¶ø‡¶®';
      
      // ================================
      // ‡ß©. ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (‡¶Æ‡¶æ‡¶∏‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü)
      // ================================
      const totalMonths = (normalized.dbYears * 12) + normalized.dbMonths + (normalized.dbDays / 30);
      
      return {
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
        inputYears: normalized.inputYears,
        inputMonths: normalized.inputMonths,
        inputDays: normalized.inputDays,
        ageInputText: inputText,
        
        // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá (‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶°)
        dbYears: normalized.dbYears,
        dbMonths: normalized.dbMonths,
        dbDays: normalized.dbDays,
        ageDisplay: displayText,
        
        // ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
        isValid: normalized.isValid,
        
        // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        ageInMonths: parseFloat(totalMonths.toFixed(2))
      };
    }

    // ==================== UNIFIED POPUP SYSTEM ====================
    function showPopup(type, title, message, options = {}) {
      // Reset popup state
      confirmationSlip.style.display = 'none';
      downloadButtons.style.display = 'none';
      popupButtons.innerHTML = '';

      // Set icon based on type
      const icons = {
        warning: '‚ö†Ô∏è',
        error: '‚ùå',
        success: '‚úÖ',
        info: '‚ÑπÔ∏è',
        confirm: '‚ùì'
      };

      popupIcon.textContent = icons[type] || '‚ö†Ô∏è';
      popupTitle.textContent = title;
      popupMessage.innerHTML = message;

      // Set button colors based on type
      const buttonColors = {
        warning: 'warning',
        error: 'cancel',
        success: 'success',
        info: 'primary',
        confirm: 'primary'
      };

      // Add buttons based on options
      if (options.showConfirm) {
        popupButtons.innerHTML = `
          <button class="popup-btn ${buttonColors[type]}" id="confirmYes">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å</button>
          <button class="popup-btn cancel" id="confirmNo">‡¶®‡¶æ</button>
        `;
        
        // Add event listeners for confirm buttons
        setTimeout(() => {
          document.getElementById('confirmYes').onclick = function() {
            if (window.popupResolve) {
              window.popupResolve(true);
            }
            closePopup();
          };
          
          document.getElementById('confirmNo').onclick = function() {
            if (window.popupResolve) {
              window.popupResolve(false);
            }
            closePopup();
          };
        }, 0);
        
      } else if (type === 'success' && options.showSlip) {
        popupButtons.innerHTML = `
          <button class="popup-btn success" onclick="resetFormAndClosePopup()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        `;
      } else if (type === 'success') {
        popupButtons.innerHTML = `
          <button class="popup-btn success" onclick="resetFormAndClosePopup()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        `;
      } else {
        popupButtons.innerHTML = `
          <button class="popup-btn ${buttonColors[type]}" onclick="closePopup()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        `;
      }

      // Show confirmation slip if requested
      if (options.showSlip && currentAppointmentData) {
        showConfirmationSlip(currentAppointmentData);
      }

      universalPopup.style.display = 'flex';
  
      // Return promise for confirm dialogs
      if (options.showConfirm) {
        return new Promise((resolve) => {
          window.popupResolve = resolve;
        });
      }
    }

    function closePopup() {
      universalPopup.style.display = 'none';
      // Clear any pending resolve function
      if (window.popupResolve) {
        window.popupResolve = null;
      }
    }

    // Close popup when clicking outside
    universalPopup.addEventListener('click', function(e) {
      if (e.target === universalPopup) {
        closePopup();
      }
    });

    // Form reset ‡¶è‡¶¨‡¶Ç popup close
    function resetFormAndClosePopup() {
      // Form reset ‡¶ï‡¶∞‡ßÅ‡¶®
      document.getElementById('appointmentForm').reset();
      serialGrid.innerHTML = '';
      serialInput.value = '';
      submitBtn.classList.remove('loading');
      submitBtn.textContent = '‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
      currentUserSelection = null;
      timeSelect.disabled = true;
      timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
      noDayMessage.style.display = 'none';
      
      // Reset grid system
      if (gridSystem) {
        gridSystem.currentSelection = null;
        gridSystem.userPendingId = null;
      }
      
      // Popup close ‡¶ï‡¶∞‡ßÅ‡¶®
      closePopup();
    }

    // ==================== CONFIRMATION SLIP SYSTEM ====================
    function showConfirmationSlip(appointmentData) {
      // Update slip content
      slipName.textContent = appointmentData.name;
      
      // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
      if (appointmentData.ageDisplay) {
        slipAge.textContent = appointmentData.ageDisplay;
      } else if (appointmentData.ageYears || appointmentData.ageMonths || appointmentData.ageDays) {
        // ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶•‡¶æ‡¶ï‡ßá
        const parts = [];
        if (appointmentData.ageYears > 0) parts.push(`${appointmentData.ageYears} ‡¶¨‡¶õ‡¶∞`);
        if (appointmentData.ageMonths > 0) parts.push(`${appointmentData.ageMonths} ‡¶Æ‡¶æ‡¶∏`);
        if (appointmentData.ageDays > 0) parts.push(`${appointmentData.ageDays} ‡¶¶‡¶ø‡¶®`);
        slipAge.textContent = parts.join(' ') || '‡ß¶ ‡¶¨‡¶õ‡¶∞ ‡ß¶ ‡¶Æ‡¶æ‡¶∏ ‡ß¶ ‡¶¶‡¶ø‡¶®';
      } else {
        // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        slipAge.textContent = appointmentData.age ? `${appointmentData.age} ‡¶¨‡¶õ‡¶∞` : '-';
      }
      
      slipPhone.textContent = appointmentData.phone;
      slipType.textContent = appointmentData.patientType === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
      slipDay.textContent = appointmentData.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
      slipTime.textContent = appointmentData.time + "\n" + "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§/‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡¶®";
      slipSerial.textContent = '#' + appointmentData.serial;
          
      // Set current date and time
      const now = new Date();
      const dateTimeString = now.toLocaleDateString('bn-BD', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      }) + ' ' + now.toLocaleTimeString('bn-BD', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      slipDateTime.textContent = dateTimeString;
      
      // Show slip and download buttons
      confirmationSlip.style.display = 'block';
      downloadButtons.style.display = 'flex';
    }

    // ==================== FIXED DOWNLOAD FUNCTIONS ====================
    async function downloadPNG() {
      try {
        console.log('üîÑ Starting PNG download...');
        
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded');
        }
        
        const slipElement = document.getElementById('confirmationSlip');
        
        if (!slipElement) {
          throw new Error('Confirmation slip element not found');
        }

        // Store original styles
        const originalStyles = {
          display: slipElement.style.display,
          position: slipElement.style.position,
          left: slipElement.style.left,
          top: slipElement.style.top,
          transform: slipElement.style.transform,
          zIndex: slipElement.style.zIndex,
          margin: slipElement.style.margin
        };

        // Create a clone for screenshot to avoid disturbing the original
        const clone = slipElement.cloneNode(true);
        clone.style.display = 'block';
        clone.style.position = 'fixed';
        clone.style.left = '0';
        clone.style.top = '0';
        clone.style.transform = 'none';
        clone.style.zIndex = '9999';
        clone.style.margin = '0';
        clone.style.background = 'white';
        
        // Append clone to body
        document.body.appendChild(clone);

        console.log('üé® Generating canvas...');
        const canvas = await html2canvas(clone, {
          scale: 3, // Higher quality
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          x: 0,
          y: 0,
          scrollX: 0,
          scrollY: 0,
          windowWidth: clone.offsetWidth,
          windowHeight: clone.offsetHeight
        });

        // Remove clone
        document.body.removeChild(clone);

        console.log('‚úÖ Canvas generated, creating download...');
        const link = document.createElement('a');
        link.download = `appointment-serial-${currentAppointmentData.serial}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ PNG download completed');
        showPopup('success', '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤', 'PNG ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      } catch (error) {
        console.error('‚ùå PNG download error:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', `PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}`);
      }
    }

    async function downloadPDF() {
      try {
        console.log('üîÑ Starting PDF download...');
        
        if (typeof window.jspdf === 'undefined') {
          throw new Error('jsPDF library not loaded');
        }
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded');
        }

        const jsPDF = window.jspdf.jsPDF;
        const slipElement = document.getElementById('confirmationSlip');
        
        if (!slipElement) {
          throw new Error('Confirmation slip element not found');
        }

        // Create a clone for screenshot
        const clone = slipElement.cloneNode(true);
        clone.style.display = 'block';
        clone.style.position = 'fixed';
        clone.style.left = '0';
        clone.style.top = '0';
        clone.style.transform = 'none';
        clone.style.zIndex = '9999';
        clone.style.margin = '0';
        clone.style.background = 'white';
        
        // Append clone to body
        document.body.appendChild(clone);

        console.log('üé® Generating canvas for PDF...');
        const canvas = await html2canvas(clone, {
          scale: 3, // Higher quality for PDF
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          x: 0,
          y: 0,
          scrollX: 0,
          scrollY: 0
        });

        // Remove clone
        document.body.removeChild(clone);

        console.log('üìÑ Creating PDF...');
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a6' // Smaller format for slip
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        // Add image to PDF
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`appointment-serial-${currentAppointmentData.serial}.pdf`);
        
        console.log('‚úÖ PDF download completed');
        showPopup('success', '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤', 'PDF ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      } catch (error) {
        console.error('‚ùå PDF download error:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', `PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}`);
      }
    }

    // ==================== FIREBASE FUNCTIONS ====================

    // Load serial ranges from Firebase
    async function loadSerialRanges() {
      if (!db) {
        console.error('‚ùå Database not initialized in appointment form');
        loadingMessage.style.display = 'none';
        return;
      }
      
      try {
        console.log('üîÑ Loading serial ranges in appointment form...');
        loadingMessage.style.display = 'block';
        serialGrid.innerHTML = '';
        
        const doc = await db.collection('settings').doc('serialRanges').get();
        
        if (doc.exists) {
          serialRanges = doc.data();
          console.log('‚úÖ Serial ranges loaded in appointment form:', serialRanges);
          
          // Ensure the structure exists with proper fallbacks
          if (!serialRanges.Thursday) serialRanges.Thursday = {};
          if (!serialRanges.Friday) serialRanges.Friday = {};
          if (!serialRanges.Thursday.new) serialRanges.Thursday.new = {};
          if (!serialRanges.Thursday.old) serialRanges.Thursday.old = {};
          if (!serialRanges.Friday.new) serialRanges.Friday.new = {};
          if (!serialRanges.Friday.old) serialRanges.Friday.old = {};
          
        } else {
          // No serial ranges found
          console.log('‚ÑπÔ∏è No serial ranges found in appointment form');
          serialRanges = { 
            Thursday: { new: {}, old: {} }, 
            Friday: { new: {}, old: {} } 
          };
        }
        
        loadingMessage.style.display = 'none';
        checkDayAvailability();
        
      } catch (error) {
        console.error('‚ùå Error loading serial ranges in appointment form:', error);
        serialRanges = { 
          Thursday: { new: {}, old: {} }, 
          Friday: { new: {}, old: {} } 
        };
        loadingMessage.style.display = 'none';
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
      }
    }

    // Check if selected day has any serial ranges
    function checkDayAvailability() {
      const day = daySelect.value;
      const type = typeSelect.value;
      
      console.log('üìÖ Checking day availability for:', day);
      
      // Reset all messages and fields
      noDayMessage.style.display = 'none';
      noSlotsMessage.style.display = 'none';
      timeSelect.disabled = true;
      timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
      serialGrid.innerHTML = '';
      serialInput.value = '';
      
      if (!day) {
        return;
      }
      
      // Check if day exists in serialRanges and has any time slots
      if (serialRanges[day] && 
          ((serialRanges[day].new && Object.keys(serialRanges[day].new).length > 0) || 
           (serialRanges[day].old && Object.keys(serialRanges[day].old).length > 0))) {
        
        console.log('‚úÖ Day has serial ranges:', day);
        timeSelect.disabled = false;
        updateTimeOptions();
        
      } else {
        console.log('‚ùå No serial ranges for day:', day);
        showPopup('warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á', 
          '‡¶è‡¶á ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá‡ß¶‡ßß‡ß≠‡ß≠‡ß≠‡ßÆ‡ßÆ‡ßÆ‡ß™‡ßÆ‡ßØ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡•§');
        timeSelect.disabled = true;
      }
    }

    // Check if phone number already has an appointment for ANY day
    async function checkExistingAppointment(phoneNumber) {
      if (!db) {
        console.error('‚ùå Database not initialized in appointment form');
        return false;
      }
      
      try {
        const snapshot = await db.collection('appointments')
          .where('phone', '==', phoneNumber)
          .get();
        
        const hasAppointment = !snapshot.empty;
        
        if (hasAppointment) {
          console.log(`üìû Phone ${phoneNumber} already has appointments:`);
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log(`   - ${data.day} at ${data.time}, Serial: ${data.serial}, Name: ${data.name}`);
          });
        } else {
          console.log(`üìû Phone ${phoneNumber} is FREE to use`);
        }
        
        return hasAppointment;
      } catch (error) {
        console.error('‚ùå Error checking existing appointment in appointment form:', error);
        return false;
      }
    }

    // Load appointments from Firebase
    function loadAppointmentsFromFirebase() {
      if (!db) {
        console.error('‚ùå Database not initialized in appointment form');
        return;
      }
      
      // Remove existing listeners
      realtimeListeners.forEach(unsubscribe => unsubscribe());
      realtimeListeners = [];

      // Load appointments
      const appointmentsListener = db.collection('appointments')
        .onSnapshot(snapshot => {
          console.log('üìÖ Appointments snapshot received');
          appointments = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            appointments.push({
              id: doc.id,
              ...data
            });
          });
          console.log('üìÖ Appointments loaded in appointment form:', appointments.length);
          
        }, error => {
          console.error('‚ùå Error loading appointments in appointment form:', error);
        });

      realtimeListeners.push(appointmentsListener);

      // Load serial ranges
      const serialRangesListener = db.collection('settings').doc('serialRanges')
        .onSnapshot(doc => {
          console.log('üîÑ Serial ranges snapshot received');
          if (doc.exists) {
            serialRanges = doc.data();
            console.log('üîÑ Serial ranges updated in appointment form:', serialRanges);
            
            // Ensure structure
            if (!serialRanges.Thursday) serialRanges.Thursday = {};
            if (!serialRanges.Friday) serialRanges.Friday = {};
            if (!serialRanges.Thursday.new) serialRanges.Thursday.new = {};
            if (!serialRanges.Thursday.old) serialRanges.Thursday.old = {};
            if (!serialRanges.Friday.new) serialRanges.Friday.new = {};
            if (!serialRanges.Friday.old) serialRanges.Friday.old = {};
            
            checkDayAvailability();
          } else {
            console.log('üì≠ No serial ranges document found');
          }
        }, error => {
          console.error('‚ùå Error listening to serial ranges in appointment form:', error);
        });

      realtimeListeners.push(serialRangesListener);
    }

    // ==================== EVENT LISTENERS ====================

    daySelect.addEventListener('change', () => {
      console.log('üìÖ Day changed to:', daySelect.value);
      checkDayAvailability();
      serialGrid.innerHTML = '';
      serialInput.value = '';
      timeSelect.value = '';
      noSlotsMessage.style.display = 'none';
      currentUserSelection = null;
    });
    
    typeSelect.addEventListener('change', () => {
      console.log('üë• Type changed to:', typeSelect.value);
      checkDayAvailability();
      serialGrid.innerHTML = '';
      serialInput.value = '';
      timeSelect.value = '';
      noSlotsMessage.style.display = 'none';
      currentUserSelection = null;
    });
    
    timeSelect.addEventListener('change', () => {
      console.log('‚è∞ Time changed to:', timeSelect.value);
      
      if (gridSystem && timeSelect.value) {
        loadingMessage.style.display = 'block';
        setTimeout(() => {
          gridSystem.updateGrid();
        }, 100);
      }
    });

    // Name validation
    nameInput.addEventListener('input', () => {
      const val = nameInput.value.trim();
      const valid = /^[\p{L}\p{M}\. ]{3,50}$/u;
      const invalidChars = /[-,;@#$%^&*]/;
      
      if(!valid.test(val) || invalidChars.test(val)) {
        nameError.style.display = 'block';
        nameInput.setCustomValidity('invalid');
      } else {
        nameError.style.display = 'none';
        nameInput.setCustomValidity('');
      }
    });

    // Age validation
    [ageYearsInput, ageMonthsInput, ageDaysInput].forEach(input => {
      input.addEventListener('input', () => {
        normalizeAgeInputs();
      });
    });

    // Phone validation
    phoneInput.addEventListener('input', () => {
      const val = phoneInput.value;
      const valid = /^01[0-9]{9}$/.test(val);
      
      if(!valid) {
        phoneError.style.display = 'block';
        phoneInput.setCustomValidity('invalid');
      } else {
        phoneError.style.display = 'none';
        phoneInput.setCustomValidity('');
      }
    });

    // Form submission
    document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!db) {
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return;
      }
      
      // Validation
      let isValid = true;
      
      // ‡¶®‡¶æ‡¶Æ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
      if(!nameInput.value.trim()) {
        nameError.style.display = 'block';
        nameInput.setCustomValidity('invalid');
        isValid = false;
      } else {
        nameError.style.display = 'none';
        nameInput.setCustomValidity('');
      }
      
      // ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® - ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
      const ageValidationData = getAgeData();
      
      if (!ageValidationData.isValid) {
        isValid = false;
      }
      
      // ‡¶´‡ßã‡¶® ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
      if(!/^01[0-9]{9}$/.test(phoneInput.value)) {
        phoneError.style.display = 'block';
        phoneInput.setCustomValidity('invalid');
        isValid = false;
      } else {
        phoneError.style.display = 'none';
        phoneInput.setCustomValidity('');
      }
      
      // ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
      if(!serialInput.value) {
        serialError.style.display = 'block';
        serialInput.setCustomValidity('invalid');
        isValid = false;
      } else {
        serialError.style.display = 'none';
        serialInput.setCustomValidity('');
      }
      
      if(!isValid) {
        showPopup('error', '‡¶´‡¶∞‡ßç‡¶Æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return false;
      }
      
      const selectedPhone = phoneInput.value;
      const selectedDay = daySelect.value;
      const selectedSerial = parseInt(serialInput.value);
      
      // Check if phone already has appointment
      // const hasExistingAppointment = await checkExistingAppointment(selectedPhone);
      // if(hasExistingAppointment) {
      //   showPopup('warning', '‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá', 
      //     '‡¶è‡¶á ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§');
      //   return false;
      // }
      
      const dayText = selectedDay === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
      const typeText = typeSelect.value === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
      
      // Show confirmation popup
      const confirmed = await showPopup('confirm', '‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶®', 
        `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?<br><br>
        <strong>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§:</strong><br>
        ‚Ä¢ ‡¶¶‡¶ø‡¶®: ${dayText}<br>
        ‚Ä¢ ‡¶∏‡¶Æ‡¶Ø‡¶º: ${timeSelect.value}<br>
        ‚Ä¢ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤: ${selectedSerial} ‡¶®‡¶Ç<br>
        ‚Ä¢ ‡¶ß‡¶∞‡¶®: ${typeText}<br>
        ‚Ä¢ ‡¶´‡ßã‡¶®: ${selectedPhone}`, 
        { showConfirm: true });
      
      if(!confirmed) {
        console.log('‚ùå User cancelled the appointment');
        return false;
      }

      // ========================
      // ‚úÖ ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç
      // ========================
      const finalAgeData = getAgeData();
      
      if (!finalAgeData.isValid) {
        showPopup('error', '‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
        return false;
      }
      
      // ========================
      // ‚úÖ Prepare data - ‡¶®‡¶§‡ßÅ‡¶® ‡ß© ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
      // ========================
      const appointmentData = {
        // Personal information
        name: nameInput.value.trim(),
        phone: selectedPhone,
        
        // ‚úÖ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá: ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶Æ‡¶æ‡¶® (‡ßß ‡¶¨‡¶õ‡¶∞ ‡ßÆ ‡¶Æ‡¶æ‡¶∏)
        ageYears: finalAgeData.dbYears,
        ageMonths: finalAgeData.dbMonths,
        ageDays: finalAgeData.dbDays,
        
        // ‚úÖ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá: ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
        ageString: finalAgeData.ageDisplay,
        
        // ‚úÖ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá‡¶§‡ßá: ‡¶è‡¶ï‡¶á ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
        ageDisplay: finalAgeData.ageDisplay,
        
        // ‡¶≤‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
        originalInput: finalAgeData.ageInputText,
          
        // Appointment information
        patientType: typeSelect.value,
        day: selectedDay,
        time: timeSelect.value,
        serial: selectedSerial,
        
        // System information
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'confirmed',
        
        // ‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶Æ‡ßç‡¶™‡ßá‡¶ü‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø
        age: finalAgeData.ageInMonths
      };

      console.log('üíæ Firebase ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§:', appointmentData);
      console.log('üìä ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ:', finalAgeData);

      // Store for slip generation
      currentAppointmentData = appointmentData;

      try {
        // Show loading
        submitBtn.classList.add('loading');
        submitBtn.textContent = '‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

        // Remove pending selection when submitting
        if (currentUserPendingId) {
          if (gridSystem) {
            await gridSystem.removePendingSelection(currentUserPendingId);
          }
          currentUserPendingId = null;
        }

        console.log('üíæ Saving appointment:', appointmentData);
        
        // Save to Firebase
        await db.collection('appointments').add(appointmentData);

        skipNoAvailabilityPopup = true;
        
        // Show success popup with download options
        showPopup('success', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 
          '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!<br><br>‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§',
          { showSlip: true });
        
        console.log('‚úÖ Appointment saved successfully');
        
      } catch (error) {
        console.error('‚ùå Error saving appointment:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        submitBtn.classList.remove('loading');
        submitBtn.textContent = '‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
      }
    });

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üèÅ Appointment form DOM loaded');
      
      // Wait for Firebase to initialize
      setTimeout(() => {
        if (db) {
          console.log('üöÄ Starting data loading...');
          loadSerialRanges();
          loadAppointmentsFromFirebase();
          
          // Initialize grid system
          initializeGridSystem();
        } else {
          console.error('‚ùå Firebase not initialized in appointment form');
        }
      }, 1000);
    });

    // Clean up pending selections when page is closed or refreshed
    window.addEventListener('beforeunload', function() {
      if (currentUserPendingId && gridSystem) {
        gridSystem.removePendingSelection(currentUserPendingId);
      }
    });
  </script>
</body>
</html>
