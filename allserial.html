<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- SweetAlert2 for beautiful popups -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
      --dark: #1f2937;
      --present: #10b981;
      --absent: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background-color: #f5f7fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Admin Container */
    .admin-container {
      display: flex;
      flex: 1;
      margin-top: 60px; /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ */
      height: calc(100vh - 60px);
    }
    
    /* Main Content */
    .admin-main {
      flex: 1;
      padding: 20px;
      background-color: #f9fafb;
      overflow-y: auto;
    }
    
    .page-title {
      color: var(--dark);
      margin-bottom: 25px;
      font-size: 24px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-gray);
    }
    
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card h3 {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .card p {
      font-size: 28px;
      font-weight: 700;
    }
    
    .card.thursday p {
      color: var(--primary);
    }
    
    .card.friday p {
      color: #8b5cf6;
    }

    .card.available p {
      color: var(--success);
    }

    .card.pending p {
      color: #4169E1;
    }
    
    .card.total p {
      color: var(--warning);
    }
    
    .card.present p {
      color: var(--present);
    }
    
    .card.absent p {
      color: var(--absent);
    }
    
    /* Alert Messages */
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .alert-success {
      background-color: #dcfce7;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .alert-error {
      background-color: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    
    /* Bulk Actions */
    .bulk-actions {
      background-color: var(--white);
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
      display: none; /* ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã */
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bulk-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .bulk-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Appointments Table Styles */
    .appointments-management {
      margin-top: 20px;
    }
    
    .appointments-management .admin-table {
      width: 100%;
      background-color: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .appointments-management .admin-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .appointments-management .admin-table-header h2 {
      font-size: 18px;
      color: var(--dark);
    }
    
    .appointments-management .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .appointments-management .filter-group {
      display: flex;
      gap: 10px;
    }
    
    .appointments-management .filter-group select {
      padding: 8px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
      background-color: var(--white);
      cursor: pointer;
    }
    
    .appointments-management .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .appointments-management .search-box {
      position: relative;
    }
    
    .appointments-management .search-box input {
      padding: 8px 15px 8px 35px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
      width: 250px;
    }
    
    .appointments-management .search-box input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .appointments-management .search-box i {
      position: absolute;
      left: 12px;
      top: 10px;
      color: var(--gray);
    }
    
    .appointments-management .export-btn {
      background-color: var(--success);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .appointments-management .export-btn:hover {
      background-color: #15803d;
    }
    
    .appointments-management .add-appointment-btn {
      background-color: var(--primary);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
    
    .appointments-management .add-appointment-btn:hover {
      background-color: var(--primary-hover);
    }
    
    .appointments-management .table-container {
      overflow-x: auto;
    }
    
    .appointments-management table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    .appointments-management th, 
    .appointments-management td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .appointments-management th {
      background-color: var(--light-gray);
      font-weight: 600;
      color: var(--dark);
    }
    
    .appointments-management tr:hover {
      background-color: #f9fafb;
    }
    
    /* Checkbox styling */
    .appointment-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Select all checkbox in header */
    .select-all-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Row with Present Status - GREEN BACKGROUND */
    tr.present-row {
      background-color: #f0fdf4 !important;
    }
    
    tr.present-row:hover {
      background-color: #dcfce7 !important;
    }
    
    /* Action Buttons */
    .appointments-management .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 13px;
      margin-right: 5px;
      transition: all 0.2s ease;
    }
    
    .appointments-management .edit-btn {
      background-color: #bfdbfe;
      color: var(--primary);
    }
    
    .appointments-management .edit-btn:hover {
      background-color: #93c5fd;
    }
    
    .appointments-management .delete-btn {
      background-color: #fee2e2;
      color: var(--danger);
    }
    
    .appointments-management .delete-btn:hover {
      background-color: #fecaca;
    }
    
    /* Bulk Action Buttons */
    .bulk-delete-btn {
      background-color: var(--danger);
      color: var(--white);
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .bulk-delete-btn:hover {
      background-color: #b91c1c;
    }
    
    .clear-selection-btn {
      background-color: var(--gray);
      color: var(--white);
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
    }
    
    .clear-selection-btn:hover {
      background-color: #4b5563;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      max-height: 90vh;
      overflow-y: auto;
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: var(--dark);
      font-size: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .close-btn:hover {
      color: var(--dark);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .form-actions button {
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      border: none;
      transition: background-color 0.2s ease;
    }
    
    .submit-btn {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .submit-btn:hover {
      background-color: var(--primary-hover);
    }
    
    .cancel-btn-modal {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .cancel-btn-modal:hover {
      background-color: #e5e7eb;
    }
    
    /* Serial Grid in Edit Modal */
    .serial-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      margin: 15px 0;
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    
    .serial-item {
      padding: 10px;
      text-align: center;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--white);
      font-weight: 500;
      font-size: 14px;
    }
    
    .serial-item.available {
      background-color: #dcfce7;
      color: var(--success);
      border-color: var(--success);
    }
    
    .serial-item.available:hover {
      background-color: #bbf7d0;
      transform: scale(1.05);
    }
    
    .serial-item.selected {
      background-color: #fef3c7;
      color: var(--warning);
      border-color: var(--warning);
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    
    .serial-item.pending {
      background-color: #dbeafe;
      color: var(--primary);
      border-color: var(--primary);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .serial-item.booked {
      background-color: #fecaca;
      color: var(--danger);
      border-color: var(--danger);
      cursor: not-allowed;
      opacity: 0.8;
    }
    
    /* Export Options */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .export-option {
      background-color: var(--light-gray);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .export-option:hover {
      background-color: #e5e7eb;
      transform: translateY(-2px);
    }
    
    .export-option i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .admin-main {
        padding: 15px;
      }
      
      .dashboard-cards {
      grid-template-columns: 1fr 1fr;
      }
      
      .card {
        padding: 15px;
      }
      
      .bulk-actions {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .bulk-buttons {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .appointments-management .admin-table-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .appointments-management .header-actions {
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }
      
      .appointments-management .filter-group {
        flex-wrap: wrap;
        width: 100%;
        gap: 8px;
      }
      
      .appointments-management .filter-group select {
        flex: 1;
        min-width: 120px;
        font-size: 14px;
        padding: 8px 12px;
      }
      
      .appointments-management .search-box {
        width: 100%;
      }
      
      .appointments-management .search-box input {
        width: 100%;
        font-size: 14px;
      }
      
      .appointments-management .export-btn,
      .appointments-management .add-appointment-btn {
        width: 100%;
        padding: 10px;
        text-align: center;
      }
      
      .modal-content {
        margin: 10px;
        width: calc(100% - 20px);
        padding: 15px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(7, 1fr);
      }
      
      .appointments-management th, 
      .appointments-management td {
        padding: 10px 12px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .admin-main {
        padding: 10px;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .page-title {
        font-size: 20px;
      }
      
      .appointments-management .filter-group select {
        min-width: 100px;
        font-size: 13px;
        padding: 6px 10px;
      }
      
      .modal-content {
        margin: 5px;
        width: calc(100% - 10px);
        padding: 12px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
      }
      
      .appointments-management .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 3px;
        margin-bottom: 3px;
      }
    }
  </style>
</head>
<body data-auto-load-components="true">
  <!-- ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
  <div id="header-container"></div>
  
  <!-- Admin Container -->
  <div class="admin-container">
    <!-- ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
    <div id="sidebar-container"></div>
    
    <!-- Main Content -->
    <main class="admin-main">
      <!-- Alert Messages Container -->
      <div id="alertContainer"></div>
      
      <!-- Dashboard Cards -->
      <div class="dashboard-cards">
        <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
        <div class="card thursday">
          <h3>‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p id="thursdayAppointments">0</p>
        </div>
        
        <div class="card friday">
          <h3>‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p id="fridayAppointments">0</p>
        </div>
        
        <div class="card total-appointments">
          <h3>‡¶Æ‡ßã‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p id="totalAppointments">0</p>
        </div>
        
        <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
        <div class="card pending">
          <h3>‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</h3>
          <p id="pendingSerials">0</p>
        </div>
        <div class="card available">
          <h3>‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</h3>
          <p id="availableSerials">0</p>
        </div>
        <div class="card total">
          <h3>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú</h3>
          <p id="totalSerials">0</p>
        </div>
      </div>
      
      <!-- Bulk Actions (‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã) -->
      <div class="bulk-actions" id="bulkActions">
        <input type="checkbox" id="selectAll" class="bulk-checkbox">
        <span id="selectedCount">0‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</span>
        <div class="bulk-buttons">
          <button class="bulk-delete-btn" id="deleteSelectedBtn">
            <i>üóëÔ∏è</i> ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
          </button>
          <button class="clear-selection-btn" id="clearSelectionBtn">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞</button>
        </div>
      </div>
      
      <!-- Appointments Management Section -->
      <div class="appointments-management">
        <div class="admin-table">
          <div class="admin-table-header">
            <h2>‡¶∏‡¶ï‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <div class="header-actions">
              <div class="filter-group">
                <select class="day-filter-appointments">
                  <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶¶‡¶ø‡¶®</option>
                  <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
                  <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
                </select>
                <select class="type-filter-appointments">
                  <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶®</option>
                  <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
                  <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
                </select>
                <select id="timeFilterSerial" class="time-filter">
                  <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>
                </select>
              </div>
              <div class="search-box">
                <i>üîç</i>
                <input type="text" class="search-appointments" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶® ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
              </div>
              <button class="export-btn" id="exportAppointmentsBtn">
                <i>üì•</i> ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
              </button>
              <button class="add-appointment-btn" id="addAppointmentBtn">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th width="50">
                    <input type="checkbox" class="select-all-checkbox" id="selectAllAppointments">
                  </th>
                  <th>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</th>
                  <th>‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                  <th>‡¶¨‡ßü‡¶∏</th>
                  <th>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                  <th>‡¶¶‡¶ø‡¶®</th>
                  <th>‡¶∏‡¶Æ‡¶Ø‡¶º</th>
                  <th>‡¶ß‡¶∞‡¶®</th>
                  <th>‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                  <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody">
                <tr>
                  <td colspan="10" style="text-align: center; padding: 20px; color: #6b7280;">
                    ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
     <!-- Edit Appointment Modal -->
<div class="modal" id="editAppointmentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
      <button class="close-btn" id="closeEditModal">&times;</button>
    </div>
    <form id="editAppointmentForm">
      <input type="hidden" id="editAppointmentId">
      
      <div class="form-group">
        <label for="editName">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
        <input type="text" id="editName" required>
      </div>
      
      <div class="form-group">
        <label for="editAge">‡¶¨‡ßü‡¶∏</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <div style="flex: 1;">
            <input type="number" id="editAgeYears" min="0" max="120" placeholder="‡¶¨‡¶õ‡¶∞" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
          </div>
          <div style="flex: 1;">
            <input type="number" id="editAgeMonths" min="0" max="11" placeholder="‡¶Æ‡¶æ‡¶∏" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
          </div>
          <div style="flex: 1;">
            <input type="number" id="editAgeDays" min="0" max="30" placeholder="‡¶¶‡¶ø‡¶®" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
          </div>
        </div>
        <input type="hidden" id="editAge" value="">
      </div>
      
      <div class="form-group">
        <label for="editPhone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
        <input type="text" id="editPhone" required>
      </div>
      
      <!-- ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶® -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
          <label for="editDay">‡¶¶‡¶ø‡¶®</label>
          <select id="editDay" required>
            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editType">‡¶ß‡¶∞‡¶®</label>
          <select id="editType" required>
            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
            <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
          </select>
        </div>
      </div>
      
      <!-- ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡ßç‡¶≤‡¶ü -->
      <div class="form-group">
        <label for="editTime">‡¶∏‡¶Æ‡¶Ø‡¶º</label>
        <select id="editTime" required>
          <option value="">-- ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
        </select>
      </div>
      
      <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ó‡ßç‡¶∞‡¶ø‡¶° -->
      <div class="form-group">
        <label for="editSerial">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
        <div class="serial-grid" id="editSerialGrid">
          <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray);">
            ‡¶¶‡¶ø‡¶®, ‡¶ß‡¶∞‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
          </div>
        </div>
        <input type="hidden" id="editSerial" value="">
      </div>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn-modal" id="cancelEditModal">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button type="submit" class="submit-btn" id="submitEditBtn">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </form>
  </div>
</div>

  <!-- Export Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶Ö‡¶™‡¶∂‡¶®</h2>
        <button class="close-btn" id="closeExportModal">&times;</button>
      </div>
      <div class="export-options">
        <div class="export-option" data-format="pdf">
          <i>üìÑ</i>
          <div>PDF</div>
        </div>
        <div class="export-option" data-format="excel">
          <i>üìä</i>
          <div>Excel</div>
        </div>
       <div class="export-option" data-format="word">
          <i>üìù</i>
          <div>Word</div>
        </div>
       <div class="export-option" data-format="docs">
         <i>üìã</i>
         <div>Docs</div>
       </div>
      </div>
    </div>
  </div>

  <!-- ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
  <div id="footer-container"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <!-- ‡¶ï‡¶Æ‡ßç‡¶™‡ßã‡¶®‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ -->
  <script src="components-inline.js"></script>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    // Global variables
    let db;
    let realtimeListeners = [];
    let appointmentsManager = null;
    let selectedAppointments = new Set();
    let searchTimer;
    let serialRanges = {
      Thursday: {
        new: {},
        old: {}
      },
      Friday: {
        new: {},
        old: {}
      }
    };
    let pendingSelections = {};
    let adminSessionId = 'admin_' + Date.now();

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      document.getElementById('alertContainer').appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showConfirmation(title, text, confirmButtonText = '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å', cancelButtonText = '‡¶®‡¶æ') {
      return Swal.fire({
        title: title,
        text: text,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#2563eb',
        cancelButtonColor: '#dc2626',
        confirmButtonText: confirmButtonText,
        cancelButtonText: cancelButtonText,
        backdrop: true,
        allowOutsideClick: false,
        allowEscapeKey: false
      });
    }

    function validateBangladeshiPhone(phone) {
      return /^(?:\+88|01)[3-9]\d{8}$/.test(phone.replace(/\s/g, ''));
    }

    function formatAge(years, months, days) {
      let ageString = '';
      if (years > 0) ageString += `${years} ‡¶¨‡¶õ‡¶∞`;
      if (months > 0) ageString += `${ageString ? ', ' : ''}${months} ‡¶Æ‡¶æ‡¶∏`;
      if (days > 0) ageString += `${ageString ? ', ' : ''}${days} ‡¶¶‡¶ø‡¶®`;
      return ageString || 'N/A';
    }

    function parseAgeString(ageString) {
      if (!ageString) return { years: 0, months: 0, days: 0 };
      
      let years = 0, months = 0, days = 0;
      
      if (ageString.includes('‡¶¨‡¶õ‡¶∞')) {
        const match = ageString.match(/(\d+)\s*‡¶¨‡¶õ‡¶∞/);
        years = match ? parseInt(match[1]) : 0;
      }
      if (ageString.includes('‡¶Æ‡¶æ‡¶∏')) {
        const match = ageString.match(/(\d+)\s*‡¶Æ‡¶æ‡¶∏/);
        months = match ? parseInt(match[1]) : 0;
      }
      if (ageString.includes('‡¶¶‡¶ø‡¶®')) {
        const match = ageString.match(/(\d+)\s*‡¶¶‡¶ø‡¶®/);
        days = match ? parseInt(match[1]) : 0;
      }
      
      return { years, months, days };
    }

    function formatDateTime(date) {
      if (!date) return 'N/A';
      const d = new Date(date);
      return d.toLocaleString('bn-BD', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (12:00 AM ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ - ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá)
    function sortTimes(times) {
      return times.sort((a, b) => {
        // Convert to 24-hour format for proper sorting
        const convertTo24Hour = (timeStr) => {
          const time = timeStr.toUpperCase();
          const [timePart, modifier] = time.split(' ');
          let [hours, minutes] = timePart.split(':').map(Number);
          
          if (modifier === 'PM' && hours !== 12) {
            hours += 12;
          }
          if (modifier === 'AM' && hours === 12) {
            hours = 0;
          }
          
          return hours * 60 + (minutes || 0);
        };
        
        const aMinutes = convertTo24Hour(a);
        const bMinutes = convertTo24Hour(b);
        
        return aMinutes - bMinutes;
      });
    }

    // ==================== AUTHENTICATION CHECK ====================
    function checkAuthentication() {
      const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!isLoggedIn) {
        Swal.fire({
          title: '‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®',
          text: '‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!',
          icon: 'warning',
          confirmButtonText: '‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®'
        }).then(() => {
          window.location.href = '/login';
        });
        return false;
      }
      
      const currentTime = new Date().getTime();
      const sessionDuration = 2 * 60 * 60 * 1000;
      
      if (currentTime - parseInt(loginTime) > sessionDuration) {
        sessionStorage.clear();
        Swal.fire({
          title: '‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßá‡¶∑',
          text: '‡¶∏‡ßá‡¶∂‡¶® ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑! ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
          icon: 'info',
          confirmButtonText: '‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá'
        }).then(() => {
          window.location.href = '/login';
        });
        return false;
      }
      
      return true;
    }

    // ==================== BULK ACTIONS FUNCTIONS ====================
    function updateBulkActions() {
      const count = selectedAppointments.size;
      document.getElementById('selectedCount').textContent = `${count}‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°`;
      
      if (count > 0) {
        document.getElementById('bulkActions').style.display = 'flex';
      } else {
        document.getElementById('bulkActions').style.display = 'none';
      }
    }

    async function deleteSelectedAppointments() {
      if (!db || selectedAppointments.size === 0) return;
      
      const count = selectedAppointments.size;
      const appointmentsText = count === 1 ? '‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø' : `${count}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü`;
      
      const result = await showConfirmation(
        '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®',
        `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${appointmentsText} ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶è‡¶á ‡¶è‡¶ï‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!`,
        '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®',
        '‡¶®‡¶æ, ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®'
      );
      
      if (!result.isConfirmed) {
        return;
      }
      
      try {
        const batch = db.batch();
        selectedAppointments.forEach(id => {
          batch.delete(db.collection('appointments').doc(id));
        });
        
        await batch.commit();
        
        selectedAppointments.clear();
        document.querySelectorAll('.appointment-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllAppointments').checked = false;
        document.getElementById('selectAll').checked = false;
        
        updateBulkActions();
        
        Swal.fire({
          title: '‡¶∏‡¶´‡¶≤!',
          text: `${count}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('‚ùå Error deleting appointments:', error);
        Swal.fire({
          title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
          text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
          icon: 'error'
        });
      }
    }

    function clearSelection() {
      selectedAppointments.clear();
      document.querySelectorAll('.appointment-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllAppointments').checked = false;
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
    }

    // ==================== APPOINTMENTS MANAGEMENT CLASS ====================
    class AppointmentsManagement {
      constructor() {
        this.db = window.db;
        this.appointments = [];
        this.timeOptions = new Set();
        this.realtimeListeners = [];
        this.searchTimer = null;
        this.currentEditSelection = null;
        this.pendingSelectionsListener = null;
        
        this.initialize();
      }
      
      async initialize() {
        await this.loadSerialRanges();
        await this.setupPendingSelectionsListener(); // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó
        await this.loadAppointments();
        this.setupEventListeners();
        this.updateStats();
      }
      
      async loadSerialRanges() {
        try {
          const doc = await this.db.collection('settings').doc('serialRanges').get();
          if (doc.exists) {
            serialRanges = doc.data();
            console.log('Serial ranges loaded:', serialRanges);
          }
        } catch (error) {
          console.error('Error loading serial ranges:', error);
        }
      }
      
      async setupPendingSelectionsListener() {
        try {
          // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
          this.pendingSelectionsListener = this.db.collection('pendingSelections')
            .where('expiresAt', '>', new Date())
            .onSnapshot(snapshot => {
              this.updatePendingSelections(snapshot);
              this.updateStats(); // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
              // ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
              if (document.getElementById('editAppointmentModal').style.display === 'flex') {
                this.updateEditSerialGrid();
              }
            }, error => {
              console.error('Error listening to pending selections:', error);
            });
          
          this.realtimeListeners.push(this.pendingSelectionsListener);
        } catch (error) {
          console.error('Error setting up pending selections listener:', error);
        }
      }
      
      updatePendingSelections(snapshot) {
        pendingSelections = {};
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.day}_${data.time}_${data.type}`;
          
          if (!pendingSelections[key]) {
            pendingSelections[key] = {
              user: [],
              admin: {}
            };
          }
          
          if (data.bookedBy === 'user') {
            pendingSelections[key].user.push({
              serial: data.serial,
              id: doc.id,
              expiresAt: data.expiresAt
            });
          } else if (data.bookedBy === 'admin') {
            if (!pendingSelections[key].admin[data.adminId]) {
              pendingSelections[key].admin[data.adminId] = [];
            }
            pendingSelections[key].admin[data.adminId].push({
              serial: data.serial,
              sessionId: data.sessionId,
              id: doc.id,
              expiresAt: data.expiresAt
            });
          }
        });
        
        console.log('Pending selections updated:', pendingSelections);
      }
      
      async loadAppointments() {
        try {
          if (!this.db) return;
          
          const listener = this.db.collection('appointments')
            .orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
              this.appointments = [];
              this.timeOptions.clear();
              
              snapshot.forEach(doc => {
                const data = {
                  id: doc.id,
                  ...doc.data()
                };
                this.appointments.push(data);
                
                if (data.time) {
                  this.timeOptions.add(data.time);
                }
              });
              
              this.populateTimeFilter();
              this.loadAppointmentsTable();
              this.updateStats(); // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            }, error => {
              console.error('Error loading appointments:', error);
              showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
            });
          
          this.realtimeListeners.push(listener);
          
        } catch (error) {
          console.error('Error loading appointments:', error);
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        }
      }
      
      populateTimeFilter() {
        const timeFilter = document.getElementById('timeFilterSerial');
        if (!timeFilter) return;
        
        timeFilter.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
        
        const sortedTimes = sortTimes(Array.from(this.timeOptions));
        
        sortedTimes.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          timeFilter.appendChild(option);
        });
      }
      
      getFilteredTimes(day, type) {
        const times = new Set();
        
        if (serialRanges[day] && serialRanges[day][type]) {
          Object.keys(serialRanges[day][type]).forEach(time => {
            times.add(time);
          });
        }
        
        this.appointments.forEach(app => {
          if (app.day === day && (app.patientType || app.type) === type && app.time) {
            times.add(app.time);
          }
        });
        
        return sortTimes(Array.from(times));
      }
      
      loadAppointmentsTable(searchTerm = '') {
        const tableBody = document.getElementById('appointmentsTableBody');
        if (!tableBody) return;
        
        const dayFilter = document.querySelector('.day-filter-appointments')?.value || 'all';
        const typeFilter = document.querySelector('.type-filter-appointments')?.value || 'all';
        const timeFilter = document.getElementById('timeFilterSerial')?.value || 'all';
        
        let html = '';
        let foundAppointments = false;
        
        const filteredAppointments = this.appointments.filter(app => {
          if (searchTerm && !(
            (app.name && app.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (app.phone && app.phone.includes(searchTerm)) ||
            (app.serial && app.serial.toString().includes(searchTerm))
          )) {
            return false;
          }
          
          if (dayFilter !== 'all' && app.day !== dayFilter) {
            return false;
          }
          
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) {
              return false;
            }
          }
          
          if (timeFilter !== 'all' && app.time !== timeFilter) {
            return false;
          }
          
          return true;
        });
        
        filteredAppointments.sort((a, b) => (a.serial || 0) - (b.serial || 0));
        
        for (const app of filteredAppointments) {
          foundAppointments = true;
          
          const dayText = app.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
          const typeText = (app.patientType || app.type) === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
          
          let ageDisplay = 'N/A';
          let ageYears = 0, ageMonths = 0, ageDays = 0;
          
          if (app.ageYears !== undefined || app.ageMonths !== undefined || app.ageDays !== undefined) {
            ageYears = Number(app.ageYears) || 0;
            ageMonths = Number(app.ageMonths) || 0;
            ageDays = Number(app.ageDays) || 0;
            ageDisplay = formatAge(ageYears, ageMonths, ageDays);
          } else if (app.age && typeof app.age === 'string') {
            const parsedAge = parseAgeString(app.age);
            ageYears = parsedAge.years;
            ageMonths = parsedAge.months;
            ageDays = parsedAge.days;
            ageDisplay = app.age;
          } else if (app.age && typeof app.age === 'number') {
            ageYears = app.age;
            ageDisplay = `${app.age} ‡¶¨‡¶õ‡¶∞`;
          }
          
          const bookingTime = app.timestamp ? 
            formatDateTime(app.timestamp.toDate ? app.timestamp.toDate() : app.timestamp) : 
            'N/A';
          
          const isSelected = selectedAppointments.has(app.id);
          
          html += `
            <tr data-id="${app.id}" data-attendance="${app.attendance || 'absent'}">
              <td>
                <input type="checkbox" class="appointment-checkbox" value="${app.id}" 
                       data-appointment-id="${app.id}"
                       ${isSelected ? 'checked' : ''}>
              </td>
              <td>${app.serial || 'N/A'}</td>
              <td>${app.name || 'N/A'}</td>
              <td>${ageDisplay}</td>
              <td style="text-align: center;">${app.phone || 'N/A'}</td>
              <td>${dayText}</td>
              <td>${app.time || 'N/A'}</td>
              <td>${typeText}</td>
              <td>${bookingTime}</td>
              <td>
                <button class="action-btn edit-btn" onclick="appointmentsManager.editAppointment('${app.id}')">
                  ‡¶è‡¶°‡¶ø‡¶ü
                </button>
                <button class="action-btn delete-btn" onclick="appointmentsManager.deleteAppointment('${app.id}')">
                  ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                </button>
              </td>
            </tr>
          `;
        }
        
        if (!foundAppointments) {
          html = `
            <tr>
              <td colspan="10" style="text-align: center; padding: 20px; color: #6b7280;">
                ${searchTerm ? '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø' : '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'}
              </td>
            </tr>
          `;
        }
        
        tableBody.innerHTML = html;
        
        document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const appointmentId = e.target.value;
            const isChecked = e.target.checked;
            
            if (isChecked) {
              selectedAppointments.add(appointmentId);
            } else {
              selectedAppointments.delete(appointmentId);
              document.getElementById('selectAllAppointments').checked = false;
              document.getElementById('selectAll').checked = false;
            }
            
            updateBulkActions();
          });
        });
      }
      
      async calculateSerialStats() {
        let totalSerialCount = 0;
        let pendingCount = 0;
        
        // Calculate total serials from ranges
        for (const day in serialRanges) {
          for (const type in serialRanges[day]) {
            for (const time in serialRanges[day][type]) {
              const [start, end] = serialRanges[day][type][time];
              totalSerialCount += (end - start + 1);
            }
          }
        }
        
        // Calculate pending serials from current data
        for (const key in pendingSelections) {
          if (pendingSelections[key]) {
            // User pending
            pendingCount += pendingSelections[key].user.length;
            
            // Admin pending
            for (const adminId in pendingSelections[key].admin) {
              pendingCount += pendingSelections[key].admin[adminId].length;
            }
          }
        }
        
        const bookedSerials = this.appointments.length;
        const availableSerials = Math.max(0, totalSerialCount - bookedSerials - pendingCount);
        
        // Update cards
        document.getElementById('totalSerials').textContent = totalSerialCount;
        document.getElementById('availableSerials').textContent = availableSerials;
        document.getElementById('pendingSerials').textContent = pendingCount;
        
        return {
          total: totalSerialCount,
          booked: bookedSerials,
          pending: pendingCount,
          available: availableSerials
        };
      }
      
      updateStats() {
        const dayFilter = document.querySelector('.day-filter-appointments')?.value;
        const typeFilter = document.querySelector('.type-filter-appointments')?.value;
        const timeFilter = document.getElementById('timeFilterSerial')?.value;
        const searchTerm = document.querySelector('.search-appointments')?.value || '';
        
        const filteredAppointments = this.appointments.filter(app => {
          if (searchTerm && !(
            (app.name && app.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (app.phone && app.phone.includes(searchTerm)) ||
            (app.serial && app.serial.toString().includes(searchTerm))
          )) {
            return false;
          }
          
          if (dayFilter !== 'all' && app.day !== dayFilter) {
            return false;
          }
          
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) {
              return false;
            }
          }
          
          if (timeFilter !== 'all' && app.time !== timeFilter) {
            return false;
          }
          
          return true;
        });
        
        const thursdayApps = filteredAppointments.filter(app => app.day === 'Thursday');
        const fridayApps = filteredAppointments.filter(app => app.day === 'Friday');
        const totalApps = filteredAppointments.length;
        
        document.getElementById('thursdayAppointments').textContent = thursdayApps.length;
        document.getElementById('fridayAppointments').textContent = fridayApps.length;
        document.getElementById('totalAppointments').textContent = totalApps;
        
        // Calculate serial stats
        this.calculateSerialStats();
      }
      
      editAppointment(id) {
        const appointment = this.appointments.find(app => app.id === id);
        
        if (!appointment) {
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
          return;
        }
        
        this.currentEditSelection = {
          id: id,
          serial: appointment.serial,
          day: appointment.day,
          time: appointment.time,
          type: appointment.patientType || appointment.type
        };
        
        document.getElementById('editAppointmentId').value = id;
        document.getElementById('editName').value = appointment.name || '';
        document.getElementById('editPhone').value = appointment.phone || '';
        
        let ageYears = 0, ageMonths = 0, ageDays = 0;
        
        if (appointment.ageYears !== undefined || appointment.ageMonths !== undefined || appointment.ageDays !== undefined) {
          ageYears = Number(appointment.ageYears) || 0;
          ageMonths = Number(appointment.ageMonths) || 0;
          ageDays = Number(appointment.ageDays) || 0;
        } else if (appointment.age && typeof appointment.age === 'string') {
          const parsedAge = parseAgeString(appointment.age);
          ageYears = parsedAge.years;
          ageMonths = parsedAge.months;
          ageDays = parsedAge.days;
        } else if (appointment.age && typeof appointment.age === 'number') {
          ageYears = appointment.age;
        }
        
        document.getElementById('editAgeYears').value = ageYears;
        document.getElementById('editAgeMonths').value = ageMonths;
        document.getElementById('editAgeDays').value = ageDays;
        
        document.getElementById('editDay').value = appointment.day || '';
        document.getElementById('editType').value = appointment.patientType || appointment.type || '';
        
        this.updateEditTimeOptions();
        
        setTimeout(() => {
          document.getElementById('editTime').value = appointment.time || '';
          document.getElementById('editSerial').value = appointment.serial || '';
          
          this.updateEditSerialGrid();
          
          if (appointment.serial) {
            setTimeout(() => {
              this.highlightEditSerial(appointment.serial);
            }, 300);
          }
        }, 100);
        
        document.getElementById('editAppointmentModal').style.display = 'flex';
      }
      
      updateEditTimeOptions() {
        const day = document.getElementById('editDay').value;
        const type = document.getElementById('editType').value;
        const timeSelect = document.getElementById('editTime');
        
        timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
        
        if (!day || !type) {
          return;
        }
        
        const times = this.getFilteredTimes(day, type);
        
        times.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          timeSelect.appendChild(option);
        });
      }
      
      updateEditSerialGrid() {
        const day = document.getElementById('editDay').value;
        const type = document.getElementById('editType').value;
        const time = document.getElementById('editTime').value;
        const serialGrid = document.getElementById('editSerialGrid');
        
        serialGrid.innerHTML = '';
        
        if (!day || !type || !time) {
          serialGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray);">‡¶¶‡¶ø‡¶®, ‡¶ß‡¶∞‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>';
          return;
        }
        
        let start = 1, end = 50;
        if (serialRanges[day] && serialRanges[day][type] && serialRanges[day][type][time]) {
          [start, end] = serialRanges[day][type][time];
        }
        
        const bookedSerials = this.appointments.filter(app => {
          const patientType = app.patientType || app.type;
          return app.id !== document.getElementById('editAppointmentId').value &&
                 app.day === day && 
                 app.time === time && 
                 patientType === type;
        }).map(app => app.serial);
        
        const pendingKey = `${day}_${time}_${type}`;
        const userPending = pendingSelections[pendingKey]?.user || [];
        const adminPending = pendingSelections[pendingKey]?.admin || {};
        
        const currentAdminPending = adminPending[adminSessionId] || [];
        const otherAdminPending = Object.keys(adminPending)
          .filter(id => id !== adminSessionId)
          .flatMap(id => adminPending[id]);
        
        const currentSerial = parseInt(document.getElementById('editSerial').value) || 0;
        const currentAppointmentId = document.getElementById('editAppointmentId').value;
        const currentAppointment = this.appointments.find(a => a.id === currentAppointmentId);
        
        for (let serial = start; serial <= end; serial++) {
          const serialItem = document.createElement('div');
          serialItem.className = 'serial-item';
          serialItem.textContent = serial;
          serialItem.setAttribute('data-serial', serial);
          
          const isCurrentAppointment = currentAppointment && 
                                       currentAppointment.serial === serial &&
                                       currentAppointment.day === day &&
                                       currentAppointment.time === time &&
                                       (currentAppointment.patientType || currentAppointment.type) === type;
          
          const isBooked = bookedSerials.includes(serial) && !isCurrentAppointment;
          const isUserPending = userPending.some(p => p.serial === serial);
          const isCurrentAdminPending = currentAdminPending.some(p => p.serial === serial);
          const isOtherAdminPending = otherAdminPending.some(p => p.serial === serial);
          
          let tooltip = `‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤: ${serial}`;
          
          if (isBooked) {
            serialItem.classList.add('booked');
            serialItem.style.cursor = 'not-allowed';
            tooltip = '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
          } else if (isUserPending) {
            serialItem.classList.add('pending');
            serialItem.style.cursor = 'not-allowed';
            tooltip = '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® (‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç)';
          } else if (isOtherAdminPending) {
            serialItem.classList.add('pending');
            serialItem.style.cursor = 'not-allowed';
            tooltip = '‡¶Ö‡¶®‡ßç‡¶Ø ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® (‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç)';
          } else if (isCurrentAppointment || isCurrentAdminPending) {
            serialItem.classList.add('selected');
            tooltip = isCurrentAppointment ? '‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü' : '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ (‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç)';
            serialItem.style.cursor = 'pointer';
            serialItem.addEventListener('click', () => {
              this.selectEditSerial(serial);
            });
          } else {
            serialItem.classList.add('available');
            serialItem.style.cursor = 'pointer';
            tooltip = '‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ - ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            serialItem.addEventListener('click', () => {
              this.selectEditSerial(serial);
            });
          }
          
          serialItem.title = tooltip;
          serialGrid.appendChild(serialItem);
        }
        
        if (window.innerWidth <= 768) {
          serialGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
        }
      }
      
      highlightEditSerial(serial) {
        document.querySelectorAll('#editSerialGrid .serial-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        
        const serialItem = document.querySelector(`#editSerialGrid .serial-item[data-serial="${serial}"]`);
        if (serialItem) {
          serialItem.classList.add('selected');
        }
      }
      
      selectEditSerial(serial) {
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤‡ßá‡¶∞ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
        const clickedItem = document.querySelector(`#editSerialGrid .serial-item[data-serial="${serial}"]`);
        
        if (clickedItem && clickedItem.classList.contains('available')) {
          // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
          document.querySelectorAll('#editSerialGrid .serial-item.selected').forEach(item => {
            item.classList.remove('selected');
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá available ‡¶õ‡¶ø‡¶≤, ‡¶§‡¶æ‡¶π‡¶≤‡ßá available ‡¶ï‡¶∞‡ßÅ‡¶®
            if (!item.classList.contains('booked') && !item.classList.contains('pending')) {
              item.classList.add('available');
            }
          });
          
          // ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
          clickedItem.classList.remove('available');
          clickedItem.classList.add('selected');
          document.getElementById('editSerial').value = serial;
        }
      }
      
      async updateAppointment(e) {
        e.preventDefault();
        
        if (!db) return;
        
        const id = document.getElementById('editAppointmentId').value;
        const newSerial = parseInt(document.getElementById('editSerial').value);
        const day = document.getElementById('editDay').value;
        const time = document.getElementById('editTime').value;
        const type = document.getElementById('editType').value;
        
        const currentAppointment = this.appointments.find(app => app.id === id);
        if (!currentAppointment) return;
        
        const oldSerial = currentAppointment.serial;
        const oldDay = currentAppointment.day;
        const oldTime = currentAppointment.time;
        const oldType = currentAppointment.patientType || currentAppointment.type;
        
        // Validation
        if (!newSerial) {
          Swal.fire({
            title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
            text: '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
            icon: 'warning'
          });
          return;
        }
        
        if (!day || !time || !type) {
          Swal.fire({
            title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
            text: '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶®, ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
            icon: 'warning'
          });
          return;
        }
        
        const years = parseInt(document.getElementById('editAgeYears').value) || 0;
        const months = parseInt(document.getElementById('editAgeMonths').value) || 0;
        const days = parseInt(document.getElementById('editAgeDays').value) || 0;
        
        if (years === 0 && months === 0 && days === 0) {
          Swal.fire({
            title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
            text: '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßü‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡¶õ‡¶∞/‡¶Æ‡¶æ‡¶∏/‡¶¶‡¶ø‡¶®)',
            icon: 'warning'
          });
          return;
        }
        
        // Age string
        let ageString = '';
        if (years > 0) ageString += `${years} ‡¶¨‡¶õ‡¶∞`;
        if (months > 0) {
          if (ageString) ageString += ', ';
          ageString += `${months} ‡¶Æ‡¶æ‡¶∏`;
        }
        if (days > 0) {
          if (ageString) ageString += ', ';
          ageString += `${days} ‡¶¶‡¶ø‡¶®`;
        }
        
        // Check serial availability
        const isAvailable = await this.checkEditSerialAvailability(id, newSerial, day, time, type);
        if (!isAvailable) {
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï‡¶°! ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
            icon: 'error'
          });
          return;
        }
        
        // Pending selection management
        if (oldSerial !== newSerial || oldDay !== day || oldTime !== time || oldType !== type) {
          const oldPendingKey = `${oldDay}_${oldTime}_${oldType}`;
          const newPendingKey = `${day}_${time}_${type}`;
          
          try {
            // Remove old pending selection for current admin
            if (pendingSelections[oldPendingKey]?.admin?.[adminSessionId]) {
              const oldPending = pendingSelections[oldPendingKey].admin[adminSessionId]
                .find(p => p.serial === oldSerial);
              
              if (oldPending) {
                await db.collection('pendingSelections').doc(oldPending.id).delete();
              }
            }
            
            // Add new pending selection for current admin
            const pendingRef = db.collection('pendingSelections').doc();
            await pendingRef.set({
              serial: newSerial,
              day: day,
              time: time,
              type: type,
              bookedBy: 'admin',
              adminId: adminSessionId,
              sessionId: adminSessionId,
              expiresAt: new Date(Date.now() + 5 * 60 * 1000),
              createdAt: new Date()
            });
            
          } catch (error) {
            console.error('Error updating pending selection:', error);
          }
        }
        
        const updatedData = {
          name: document.getElementById('editName').value,
          age: ageString,
          ageYears: years,
          ageMonths: months,
          ageDays: days,
          phone: document.getElementById('editPhone').value,
          day: day,
          time: time,
          patientType: type,
          serial: newSerial,
          updatedAt: new Date()
        };

        try {
          document.getElementById('submitEditBtn').innerHTML = '<div class="loading"></div>';
          document.getElementById('submitEditBtn').disabled = true;
          
          await db.collection('appointments').doc(id).update(updatedData);
          
          this.currentEditSelection = null;
          
          document.getElementById('editAppointmentModal').style.display = 'none';
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          console.error('‚ùå Error updating appointment:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        } finally {
          document.getElementById('submitEditBtn').innerHTML = '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
          document.getElementById('submitEditBtn').disabled = false;
        }
      }
      
      async checkEditSerialAvailability(currentId, newSerial, day, time, type) {
        const otherBookings = this.appointments.filter(app => 
          app.id !== currentId && 
          app.day === day && 
          app.time === time && 
          (app.patientType || app.type) === type &&
          app.serial === newSerial
        );
        
        return otherBookings.length === 0;
      }
      
      async deleteAppointment(appointmentId) {
        const appointment = this.appointments.find(app => app.id === appointmentId);
        if (!appointment) return;
        
        const result = await showConfirmation(
          '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®',
          `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${appointment.name}" ‡¶è‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤: ${appointment.serial}\n‡¶¶‡¶ø‡¶®: ${appointment.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞'}\n‡¶∏‡¶Æ‡¶Ø‡¶º: ${appointment.time}\n\n‡¶è‡¶á ‡¶è‡¶ï‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!`,
          '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®',
          '‡¶®‡¶æ, ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®'
        );
        
        if (!result.isConfirmed) {
          return;
        }
        
        try {
          await this.db.collection('appointments').doc(appointmentId).delete();
          
          if (selectedAppointments.has(appointmentId)) {
            selectedAppointments.delete(appointmentId);
            updateBulkActions();
          }
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          console.error('Error deleting appointment:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      setupEventListeners() {
        document.querySelector('.day-filter-appointments')?.addEventListener('change', (e) => {
          const day = e.target.value;
          const type = document.querySelector('.type-filter-appointments').value;
          this.updateTimeFilterOptions(day, type);
          this.loadAppointmentsTable();
          this.updateStats();
        });
        
        document.querySelector('.type-filter-appointments')?.addEventListener('change', (e) => {
          const day = document.querySelector('.day-filter-appointments').value;
          const type = e.target.value;
          this.updateTimeFilterOptions(day, type);
          this.loadAppointmentsTable();
          this.updateStats();
        });
        
        document.getElementById('timeFilterSerial')?.addEventListener('change', () => {
          this.loadAppointmentsTable();
          this.updateStats();
        });
        
        const searchInput = document.querySelector('.search-appointments');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            clearTimeout(this.searchTimer);
            this.searchTimer = setTimeout(() => {
              this.loadAppointmentsTable(e.target.value);
              this.updateStats();
            }, 300);
          });
        }
        
        document.getElementById('addAppointmentBtn')?.addEventListener('click', () => {
          Swal.fire({
            title: '‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá!',
            text: '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá',
            icon: 'info'
          });
        });
        
        document.getElementById('exportAppointmentsBtn')?.addEventListener('click', () => {
          document.getElementById('exportModal').style.display = 'flex';
        });
        
        document.querySelectorAll('.export-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const format = e.currentTarget.getAttribute('data-format');
            this.exportData(format);
          });
        });
        
        document.getElementById('closeExportModal')?.addEventListener('click', () => {
          document.getElementById('exportModal').style.display = 'none';
        });
        
        document.getElementById('selectAllAppointments')?.addEventListener('change', (e) => {
          const isChecked = e.target.checked;
          document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
            const appointmentId = checkbox.value;
            checkbox.checked = isChecked;
            
            if (isChecked) {
              selectedAppointments.add(appointmentId);
            } else {
              selectedAppointments.delete(appointmentId);
            }
          });
          updateBulkActions();
        });
        
        document.getElementById('selectAll')?.addEventListener('change', (e) => {
          const isChecked = e.target.checked;
          document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
            const appointmentId = checkbox.value;
            checkbox.checked = isChecked;
            
            if (isChecked) {
              selectedAppointments.add(appointmentId);
            } else {
              selectedAppointments.delete(appointmentId);
            }
          });
          document.getElementById('selectAllAppointments').checked = isChecked;
          updateBulkActions();
        });
        
        document.getElementById('deleteSelectedBtn')?.addEventListener('click', () => {
          deleteSelectedAppointments();
        });
        
        document.getElementById('clearSelectionBtn')?.addEventListener('click', () => {
          clearSelection();
        });
        
        document.getElementById('editAppointmentForm')?.addEventListener('submit', (e) => {
          this.updateAppointment(e);
        });
        
        document.getElementById('editDay')?.addEventListener('change', () => {
          this.updateEditTimeOptions();
          document.getElementById('editTime').value = '';
          this.updateEditSerialGrid();
        });
        
        document.getElementById('editType')?.addEventListener('change', () => {
          this.updateEditTimeOptions();
          document.getElementById('editTime').value = '';
          this.updateEditSerialGrid();
        });
        
        document.getElementById('editTime')?.addEventListener('change', () => {
          this.updateEditSerialGrid();
        });
        
        document.getElementById('closeEditModal')?.addEventListener('click', () => {
          document.getElementById('editAppointmentModal').style.display = 'none';
          this.currentEditSelection = null;
        });
        
        document.getElementById('cancelEditModal')?.addEventListener('click', () => {
          document.getElementById('editAppointmentModal').style.display = 'none';
          this.currentEditSelection = null;
        });
        
        window.addEventListener('click', (e) => {
          if (e.target === document.getElementById('editAppointmentModal')) {
            document.getElementById('editAppointmentModal').style.display = 'none';
            this.currentEditSelection = null;
          }
          if (e.target === document.getElementById('exportModal')) {
            document.getElementById('exportModal').style.display = 'none';
          }
        });
      }
      
      updateTimeFilterOptions(day, type) {
        const timeFilter = document.getElementById('timeFilterSerial');
        timeFilter.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
        
        if (day === 'all' || type === 'all') {
          const allTimes = new Set();
          
          for (const d in serialRanges) {
            if (day !== 'all' && d !== day) continue;
            
            for (const t in serialRanges[d]) {
              if (type !== 'all' && t !== type) continue;
              
              for (const time in serialRanges[d][t]) {
                allTimes.add(time);
              }
            }
          }
          
          const sortedTimes = sortTimes(Array.from(allTimes));
          sortedTimes.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeFilter.appendChild(option);
          });
        } else {
          const times = this.getFilteredTimes(day, type);
          times.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeFilter.appendChild(option);
          });
        }
      }
      
      exportData(format) {
        const dayFilter = document.querySelector('.day-filter-appointments')?.value || 'all';
        const typeFilter = document.querySelector('.type-filter-appointments')?.value || 'all';
        const timeFilter = document.getElementById('timeFilterSerial')?.value || 'all';
        const searchTerm = document.querySelector('.search-appointments')?.value || '';
        
        const filteredAppointments = this.appointments.filter(app => {
          if (searchTerm && !(
            (app.name && app.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (app.phone && app.phone.includes(searchTerm)) ||
            (app.serial && app.serial.toString().includes(searchTerm))
          )) {
            return false;
          }
          
          if (dayFilter !== 'all' && app.day !== dayFilter) {
            return false;
          }
          
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) {
              return false;
            }
          }
          
          if (timeFilter !== 'all' && app.time !== timeFilter) {
            return false;
          }
          
          return true;
        });
        
        if (filteredAppointments.length === 0) {
          Swal.fire({
            title: '‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á',
            text: '‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á',
            icon: 'warning'
          });
          document.getElementById('exportModal').style.display = 'none';
          return;
        }
        
        switch(format) {
          case 'pdf':
            this.exportToPDF(filteredAppointments);
            break;
          case 'excel':
            this.exportToExcel(filteredAppointments);
            break;
          case 'word':
            this.exportToWord(filteredAppointments);
            break;
          case 'docs':
            this.exportToHTMLDocs(filteredAppointments);
            break;
        }
        
        document.getElementById('exportModal').style.display = 'none';
      }
      
      exportToPDF(appointments) {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
          
          doc.setFontSize(16);
          doc.setTextColor(40, 40, 150);
          doc.text('Doctor Appointment Report', 105, 20, { align: 'center' });
          
          doc.setFontSize(10);
          doc.setTextColor(80, 80, 80);
          doc.text(`Generated Date: ${new Date().toLocaleDateString('en-BD')} | Time: ${new Date().toLocaleTimeString('en-BD')}`, 14, 30);
          
          const summaryLines = [
            `‚Ä¢ Total Appointments: ${sortedAppointments.length}`,
            `‚Ä¢ Day: ${document.querySelector('.day-filter-appointments').value === 'all' ? 'All Days' : document.querySelector('.day-filter-appointments').value}`,
            `‚Ä¢ Type: ${document.querySelector('.type-filter-appointments').value === 'all' ? 'All Types' : document.querySelector('.type-filter-appointments').value}`,
            `‚Ä¢ Filtered Time: ${document.getElementById('timeFilterSerial').value === 'all' ? 'All Times' : document.getElementById('timeFilterSerial').value}`
          ];
          
          let yPosition = 40;
          summaryLines.forEach((text, index) => {
            doc.text(text, 14, yPosition);
            yPosition += 6;
          });
          
          const headers = [['Serial', 'Patient Name', 'Age', 'Phone', 'Day', 'Time', 'Type', 'Booking Date']];
          
          const data = sortedAppointments.map(app => [
            app.serial.toString(),
            app.name,
            app.age || 'N/A',
            app.phone,
            app.day === 'Thursday' ? 'Thursday' : 'Friday',
            app.time,
            (app.patientType || app.type) === 'new' ? 'New' : 'Old',
            app.timestamp ? 
              new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
              new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A'
          ]);
          
          doc.autoTable({
            head: headers,
            body: data,
            startY: 65,
            styles: { 
              font: 'helvetica',
              fontSize: 9,
              cellPadding: 3
            },
            headStyles: { 
              fillColor: [41, 128, 185],
              textColor: 255,
              fontStyle: 'bold'
            },
            alternateRowStyles: {
              fillColor: [245, 245, 245]
            }
          });
          
          const pageCount = doc.internal.getNumberOfPages();
          for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} / ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
          }
          
          const fileName = `appointments_${new Date().toISOString().split('T')[0]}.pdf`;
          doc.save(fileName);
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: `${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü PDF ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('PDF export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: 'PDF ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      exportToExcel(appointments) {
        try {
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
          
          const data = sortedAppointments.map(app => ({
            'Serial No': app.serial,
            'Patient Name': app.name,
            'Age': app.age || 'N/A',
            'Phone Number': app.phone || 'N/A',
            'Day': app.day === 'Thursday' ? 'Thursday' : 'Friday',
            'Time': app.time,
            'Type': (app.patientType || app.type) === 'new' ? 'New Patient' : 'Old Patient',
            'Booking Date': app.timestamp ? 
              new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
              new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A'
          }));
          
          const ws = XLSX.utils.json_to_sheet(data);
          
          const colWidths = [
            { wch: 10 }, { wch: 20 }, { wch: 15 }, { wch: 15 },
            { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 20 }
          ];
          ws['!cols'] = colWidths;
          
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Appointments');
          
          const fileName = `appointments_${new Date().toISOString().split('T')[0]}.xlsx`;
          XLSX.writeFile(wb, fileName);
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: `${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü Excel ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('Excel export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: 'Excel ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      exportToWord(appointments) {
        try {
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);

          let wordContent = `
    <meta charset="UTF-8">
    <html>
    <body>
      <h1 style="text-align: center; color: #2563eb; margin-bottom: 10px;">Doctor Appointment Report</h1>
      
      <p style="text-align: center; color: #666; margin-bottom: 15px;">
        <strong>Generated Date:</strong> ${new Date().toLocaleDateString('en-BD')} | 
        <strong>Time:</strong> ${new Date().toLocaleTimeString('en-BD')}
      </p>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
        <strong>Summary:</strong><br>
        ‚Ä¢ Total Appointments: ${sortedAppointments.length}<br>
        ‚Ä¢ Day: ${document.querySelector('.day-filter-appointments').value === 'all' ? 'All Days' : document.querySelector('.day-filter-appointments').value}<br>
        ‚Ä¢ Type: ${document.querySelector('.type-filter-appointments').value === 'all' ? 'All Types' : document.querySelector('.type-filter-appointments').value}<br>
        ‚Ä¢ Filtered Time: ${document.getElementById('timeFilterSerial').value === 'all' ? 'All Times' : document.getElementById('timeFilterSerial').value}
      </div>

      <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-size: 12px;">
        <tr style="background-color: #2563eb; color: white; font-weight: bold;">
          <th>Serial</th>
          <th>Patient Name</th>
          <th>Age</th>
          <th>Phone</th>
          <th>Day</th>
          <th>Time</th>
          <th>Type</th>
          <th>Booking Date</th>
        </tr>
        ${sortedAppointments.map(app => {
          const age = app.age || 'N/A';
          const bookingDate = app.timestamp ? 
            new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
            new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A';
          
          return `
        <tr>
          <td>${app.serial}</td>
          <td>${app.name}</td>
          <td>${age}</td>
          <td>${app.phone || 'N/A'}</td>
          <td>${app.day === 'Thursday' ? 'Thursday' : 'Friday'}</td>
          <td>${app.time}</td>
          <td>${(app.patientType || app.type) === 'new' ? 'New' : 'Old'}</td>
          <td>${bookingDate}</td>
        </tr>`;
        }).join('')}
      </table>
      
      <p style="margin-top: 20px; color: #666; font-size: 11px; text-align: center;">
        Generated by Admin Dashboard | ${new Date().getFullYear()}
      </p>
    </body>
    </html>`;

          const blob = new Blob([wordContent], { type: 'application/msword' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `appointments_${new Date().toISOString().split('T')[0]}.doc`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: `${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü Word ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('Word export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: 'Word ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      exportToHTMLDocs(appointments) {
        try {
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
          
          const htmlContent = `
    <meta charset="UTF-8">
    <html>
    <head>
      <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 20px;
          box-sizing: border-box;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          font-size: 11px;
          table-layout: fixed;
        }
        th, td {
          border: 1px solid #000;
          padding: 6px;
          word-wrap: break-word;
        }
      </style>
    </head>
    <body>
      <h1 style="text-align: center; color: #2563eb; margin-bottom: 10px; font-size: 16px;">Doctor Appointment Report</h1>
      
      <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 12px;">
        <strong>Generated Date:</strong> ${new Date().toLocaleDateString('en-BD')} | 
        <strong>Time:</strong> ${new Date().toLocaleTimeString('en-BD')}
      </p>
      
      <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2563eb; font-size: 11px;">
        <strong>Summary:</strong><br>
        ‚Ä¢ Total Appointments: ${sortedAppointments.length}<br>
        ‚Ä¢ Day: ${document.querySelector('.day-filter-appointments').value === 'all' ? 'All Days' : document.querySelector('.day-filter-appointments').value}<br>
        ‚Ä¢ Type: ${document.querySelector('.type-filter-appointments').value === 'all' ? 'All Types' : document.querySelector('.type-filter-appointments').value}<br>
        ‚Ä¢ Filtered Time: ${document.getElementById('timeFilterSerial').value === 'all' ? 'All Times' : document.getElementById('timeFilterSerial').value}
      </div>

      <table>
        <tr style="background-color: #2563eb; color: white; font-weight: bold;">
          <th style="width: 8%">Serial</th>
          <th style="width: 20%">Patient Name</th>
          <th style="width: 12%">Age</th>
          <th style="width: 15%">Phone</th>
          <th style="width: 10%">Day</th>
          <th style="width: 10%">Time</th>
          <th style="width: 10%">Type</th>
          <th style="width: 15%">Booking Date</th>
        </tr>
        ${sortedAppointments.map(app => {
          let age = 'N/A';
          
          if (app.ageYears || app.ageMonths || app.ageDays) {
            const parts = [];
            if (app.ageYears && app.ageYears > 0) parts.push(`${app.ageYears} Years`);
            if (app.ageMonths && app.ageMonths > 0) parts.push(`${app.ageMonths} Months`);
            if (app.ageDays && app.ageDays > 0) parts.push(`${app.ageDays} Day`);
            age = parts.join(' ');
          } else if (app.age) {
            if (!isNaN(app.age) && app.age !== '') {
              age = app.age + ' Years';
            } else if (typeof app.age === 'string') {
              age = app.age;
            }
          }
          
          let bookingDate = 'N/A';
          if (app.timestamp) {
            let dateObj;
            
            if (app.timestamp.toDate && typeof app.timestamp.toDate === 'function') {
              dateObj = app.timestamp.toDate();
            } else if (app.timestamp.seconds) {
              dateObj = new Date(app.timestamp.seconds * 1000);
            } else if (app.timestamp instanceof Date) {
              dateObj = app.timestamp;
            } else if (typeof app.timestamp === 'string') {
              dateObj = new Date(app.timestamp);
            }
            
            if (dateObj && !isNaN(dateObj.getTime())) {
              const dateStr = dateObj.toLocaleDateString('en-BD');
              const timeStr = dateObj.toLocaleTimeString('en-BD', {
                hour: '2-digit', 
                minute: '2-digit'
              });
              bookingDate = `${dateStr} ${timeStr}`;
            }
          }
          
          return `
        <tr>
          <td style="width: 8%">${app.serial}</td>
          <td style="width: 20%">${app.name}</td>
          <td style="width: 12%">${age}</td>
          <td style="width: 15%">${app.phone}</td>
          <td style="width: 10%">${app.day === 'Thursday' ? 'Thursday' : 'Friday'}</td>
          <td style="width: 10%">${app.time}</td>
          <td style="width: 10%">${(app.patientType || app.type) === 'new' ? 'New' : 'Old'}</td>
          <td style="width: 15%">${bookingDate}</td>
        </tr>`;
        }).join('')}
      </table>
      
      <p style="margin-top: 15px; color: #666; font-size: 10px; text-align: center;">
        Generated by Admin Dashboard | ${new Date().getFullYear()}
      </p>
    </body>
    </html>`;

          const blob = new Blob([htmlContent], { 
            type: 'text/html; charset=utf-8'
          });
          
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `appointments_${new Date().toISOString().split('T')[0]}.html`;
          
          link.click();
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            html: `
              <div style="text-align: left;">
                <strong>‚úÖ ‡¶°‡¶ï‡ßç‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</strong><br><br>
                <strong>Google Docs ‡¶è ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá:</strong><br>
                1. Google Docs ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                2. File ‚Üí Import ‚Üí Upload<br>
                3. ‡¶è‡¶á HTML ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                4. Insert ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
              </div>
            `,
            icon: 'success',
            timer: 8000,
            showConfirmButton: true
          });
          
          setTimeout(() => URL.revokeObjectURL(url), 5000);
          
        } catch (error) {
          console.error('Docs export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶°‡¶ï‡ßç‡¶∏ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      destroy() {
        this.realtimeListeners.forEach(unsubscribe => {
          if (unsubscribe && typeof unsubscribe === 'function') {
            unsubscribe();
          }
        });
      }
    }

    // ==================== INITIALIZATION ====================
    function initializeFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully");
        
        window.db = db;
        return true;
      } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        Swal.fire({
          title: 'Firebase ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
          text: '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message,
          icon: 'error'
        });
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuthentication()) {
        return;
      }
      
      if (initializeFirebase()) {
        setTimeout(() => {
          appointmentsManager = new AppointmentsManagement();
          console.log('‚úÖ Appointments Management initialized');
          
          setTimeout(() => {
            Swal.fire({
              title: '‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!',
              text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ',
              icon: 'success',
              timer: 2000,
              showConfirmButton: false
            });
          }, 1000);
        }, 100);
      }
    });

    window.addEventListener('beforeunload', function() {
      if (appointmentsManager) {
        appointmentsManager.destroy();
      }
      
      if (realtimeListeners.length > 0) {
        realtimeListeners.forEach(unsubscribe => {
          if (unsubscribe && typeof unsubscribe === 'function') {
            unsubscribe();
          }
        });
      }
    });
  </script>
</body>
</html>