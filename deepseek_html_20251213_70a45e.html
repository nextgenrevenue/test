<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>লাইভ সিরিয়াল ম্যানেজমেন্ট</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="components-inline.js"></script> 
  
  <style>
    /* ======================================================== */
    /* ভেরিয়েবল এবং রিসেট */
    /* ======================================================== */
    :root {
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --success-hover: #059669;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --warning: #f59e0b;
      --warning-hover: #d97706;
      --info: #0ea5e9;
      --purple: #8b5cf6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --white: #ffffff;
      --black: #000000;
      
      --background: #f8fafc;
      --card-background: var(--white);
      --text-color: var(--gray-800);
      --secondary-text: var(--gray-600);
      --border-color: var(--gray-200);
      --sidebar-width: 280px;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 6px 12px -3px rgba(0, 0, 0, 0.1), 0 4px 8px -2px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 16px -4px rgba(0, 0, 0, 0.08);
      --shadow-xl: 0 20px 40px -10px rgba(0, 0, 0, 0.15), 0 15px 30px -6px rgba(0, 0, 0, 0.12);
      
      --radius-sm: 6px;
      --radius: 10px;
      --radius-lg: 14px;
      --radius-xl: 18px;
      
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--background);
      color: var(--text-color);
      font-family: 'Noto Sans Bengali', sans-serif;
      overflow-x: hidden;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ======================================================== */
    /* লেআউট */
    /* ======================================================== */
    .admin-container {
      display: flex;
      min-height: 100vh;
      padding-top: 64px;
      transition: var(--transition);
    }

    .sidebar-open .admin-container {
      padding-left: 280px;
    }

    .admin-main {
      flex: 1;
      padding: 24px;
      min-height: calc(100vh - 64px);
      width: 100%;
      transition: var(--transition);
    }

    /* ======================================================== */
    /* হেডিং এবং সেকশন */
    /* ======================================================== */
    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-header h1::before {
      content: '';
      display: block;
      width: 4px;
      height: 28px;
      background: linear-gradient(180deg, var(--primary), var(--purple));
      border-radius: 2px;
    }

    .page-header .subtitle {
      color: var(--gray-500);
      font-size: 16px;
      font-weight: 500;
    }

    .section {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-md);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
      font-size: 20px;
    }

    /* ======================================================== */
    /* ড্যাশবোর্ড স্ট্যাটস কার্ড */
    /* ======================================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 22px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--purple));
    }

    .stat-card.called-apps::before { background: linear-gradient(90deg, var(--success), #34d399); }
    .stat-card.not-called-apps::before { background: linear-gradient(90deg, var(--danger), #f87171); }
    .stat-card.token-given-apps::before { background: linear-gradient(90deg, var(--warning), #fbbf24); }
    .stat-card.token-not-given-apps::before { background: linear-gradient(90deg, var(--primary), #60a5fa); }
    .stat-card.thursday::before { background: linear-gradient(90deg, #8b5cf6, #c4b5fd); }
    .stat-card.friday::before { background: linear-gradient(90deg, #ec4899, #f472b6); }
    .stat-card.total-appointments::before { background: linear-gradient(90deg, var(--info), #7dd3fc); }
    .stat-card.pending::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .stat-card.total::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
    .stat-card.available::before { background: linear-gradient(90deg, #10b981, #34d399); }
    .stat-card.new-call::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
    .stat-card.old-call::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .stat-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .stat-card.called-apps .stat-icon { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .stat-card.not-called-apps .stat-icon { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .stat-card.token-given-apps .stat-icon { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .stat-card.token-not-given-apps .stat-icon { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
    .stat-card.thursday .stat-icon { background: rgba(139, 92, 246, 0.1); color: var(--purple); }
    .stat-card.friday .stat-icon { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
    .stat-card.total-appointments .stat-icon { background: rgba(14, 165, 233, 0.1); color: var(--info); }
    .stat-card.pending .stat-icon { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .stat-card.total .stat-icon { background: rgba(99, 102, 241, 0.1); color: #6366f1; }
    .stat-card.available .stat-icon { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .stat-card.new-call .stat-icon { background: rgba(6, 182, 212, 0.1); color: #06b6d4; }
    .stat-card.old-call .stat-icon { background: rgba(139, 92, 246, 0.1); color: var(--purple); }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-trend {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-trend.positive {
      color: var(--success);
    }

    .stat-trend.negative {
      color: var(--danger);
    }

    /* ======================================================== */
    /* ফিল্টার সেকশন */
    /* ======================================================== */
    .filter-section {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-label i {
      color: var(--primary);
      font-size: 16px;
    }

    .filter-select, .filter-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 14px;
      color: var(--gray-800);
      background: var(--white);
      transition: var(--transition);
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-container {
      position: relative;
    }

    .search-input {
      padding-left: 44px;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      pointer-events: none;
    }

    .filter-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .add-serial-btn {
      padding: 12px 28px;
      background: linear-gradient(135deg, var(--success), var(--success-hover));
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow);
    }

    .add-serial-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--success-hover), #047857);
    }

    .add-serial-btn i {
      font-size: 18px;
    }

    .stats-summary {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      padding: 16px 24px;
      border-radius: var(--radius);
      text-align: center;
      font-weight: 600;
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    /* ======================================================== */
    /* ডেটা টেবিল */
    /* ======================================================== */
    .data-section {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 0;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .table-container {
      overflow-x: auto;
      max-height: calc(100vh - 450px);
      min-height: 300px;
      position: relative;
    }

    .table-container::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }

    .table-container::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    #appointmentsTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 1200px;
    }

    #appointmentsTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #appointmentsTable th {
      background: linear-gradient(180deg, var(--gray-50), var(--gray-100));
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 14px;
      white-space: nowrap;
      border-bottom: 2px solid var(--border-color);
      position: relative;
    }

    #appointmentsTable th::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--purple));
      opacity: 0;
      transition: var(--transition);
    }

    #appointmentsTable th:hover::after {
      opacity: 1;
    }

    #appointmentsTable td {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
      vertical-align: middle;
      color: var(--gray-700);
    }

    #appointmentsTable tbody tr {
      transition: var(--transition);
    }

    #appointmentsTable tbody tr:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }

    #appointmentsTable tbody tr:last-child td {
      border-bottom: none;
    }

    /* স্ট্যাটাস ব্যাজ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      gap: 6px;
      border: 1px solid transparent;
    }

    .status-badge i {
      font-size: 10px;
    }

    .status-called {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      color: #065f46;
      border-color: rgba(16, 185, 129, 0.2);
    }

    .status-not-called {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      color: #991b1b;
      border-color: rgba(239, 68, 68, 0.2);
    }

    .status-token-given {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
      color: #92400e;
      border-color: rgba(245, 158, 11, 0.2);
    }

    .status-token-not-given {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
      color: #1e40af;
      border-color: rgba(59, 130, 246, 0.2);
    }

    /* অ্যাকশন বাটন */
    .action-btn {
      padding: 8px 18px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: var(--transition);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 100px;
    }

    .action-btn i {
      font-size: 12px;
    }

    .btn-call {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: var(--white);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-call:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, var(--primary-hover), #1d4ed8);
    }

    .btn-call-undo {
      background: linear-gradient(135deg, var(--danger), var(--danger-hover));
      color: var(--white);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-call-undo:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      background: linear-gradient(135deg, var(--danger-hover), #b91c1c);
    }

    .btn-token {
      background: linear-gradient(135deg, var(--warning), var(--warning-hover));
      color: var(--white);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .btn-token:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      background: linear-gradient(135deg, var(--warning-hover), #d97706);
    }

    .btn-token-undo {
      background: linear-gradient(135deg, var(--info), #0284c7);
      color: var(--white);
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    }

    .btn-token-undo:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
      background: linear-gradient(135deg, #0284c7, #0369a1);
    }

    /* লোডিং এবং খালি স্টেট */
    .loading-state, .empty-state {
      padding: 60px 20px;
      text-align: center;
      color: var(--gray-500);
    }

    .loading-state i, .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--gray-300);
    }

    .loading-state p, .empty-state p {
      font-size: 16px;
      font-weight: 500;
    }

    /* ======================================================== */
    /* মোডাল */
    /* ======================================================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 32px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
      animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 28px;
    }

    .modal-header h2 {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-header h2 i {
      color: var(--primary);
    }

    .close-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: var(--transition);
    }

    .close-btn:hover {
      background: var(--gray-200);
      color: var(--gray-900);
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 22px;
    }

    .form-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 14px;
    }

    .form-label span.required {
      color: var(--danger);
      margin-left: 4px;
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 14px;
      color: var(--gray-800);
      background: var(--white);
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .age-fields {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .serial-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin: 16px 0;
    }

    .serial-item {
      padding: 12px 8px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
      background: var(--white);
    }

    .serial-item:hover:not(.booked) {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.05);
      transform: translateY(-2px);
    }

    .serial-item.booked {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      color: var(--gray-400);
      border-color: #fecaca;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .serial-item.selected {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: var(--white);
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .patient-type-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .patient-type-card {
      padding: 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: var(--white);
    }

    .patient-type-card:hover {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.05);
    }

    .patient-type-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .patient-type-card h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 8px;
    }

    .patient-type-card p {
      font-size: 12px;
      color: var(--gray-500);
      margin: 0;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .form-actions button {
      flex: 1;
      padding: 16px;
      border-radius: var(--radius);
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-submit {
      background: linear-gradient(135deg, var(--success), var(--success-hover));
      color: var(--white);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
      background: linear-gradient(135deg, var(--success-hover), #047857);
    }

    .btn-cancel {
      background: linear-gradient(135deg, var(--gray-300), var(--gray-400));
      color: var(--white);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2);
    }

    .btn-cancel:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(107, 114, 128, 0.3);
      background: linear-gradient(135deg, var(--gray-400), var(--gray-500));
    }

    /* ======================================================== */
    /* রেসপনসিভ ডিজাইন */
    /* ======================================================== */
    @media (max-width: 1200px) {
      .sidebar-open .admin-container {
        padding-left: 0;
      }
      
      .admin-main {
        padding: 20px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
      }
      
      .filter-grid,
      .filter-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .table-container {
        max-height: calc(100vh - 400px);
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        padding-top: 60px;
      }
      
      .admin-main {
        padding: 16px;
        min-height: calc(100vh - 60px);
      }
      
      .page-header h1 {
        font-size: 24px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .stat-card {
        padding: 18px;
      }
      
      .stat-value {
        font-size: 28px;
      }
      
      .filter-grid,
      .filter-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .filter-actions {
        flex-direction: column;
        gap: 16px;
      }
      
      .add-serial-btn {
        width: 100%;
        justify-content: center;
      }
      
      .table-container {
        max-height: calc(100vh - 450px);
        min-height: 400px;
      }
      
      #appointmentsTable th,
      #appointmentsTable td {
        padding: 12px 14px;
        font-size: 13px;
      }
      
      .action-btn {
        min-width: 90px;
        padding: 7px 14px;
        font-size: 12px;
      }
      
      .status-badge {
        padding: 5px 10px;
        font-size: 11px;
      }
      
      .modal-content {
        padding: 24px 20px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }
      
      .age-fields {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      .admin-main {
        padding: 12px;
      }
      
      .page-header h1 {
        font-size: 22px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .stat-card {
        padding: 16px 14px;
      }
      
      .stat-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      .section {
        padding: 20px 16px;
      }
      
      .filter-section {
        padding: 20px 16px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .patient-type-selector {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      #appointmentsTable {
        min-width: 800px;
      }
      
      .table-container {
        max-height: 400px;
      }
    }

    /* ল্যান্ডস্কেপ মোড */
    @media (max-height: 600px) and (orientation: landscape) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .table-container {
        max-height: 300px;
      }
    }

    /* ডার্ক মোড সাপোর্ট */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: #0f172a;
        --card-background: #1e293b;
        --text-color: #f1f5f9;
        --secondary-text: #cbd5e1;
        --border-color: #334155;
        --gray-50: #1e293b;
        --gray-100: #334155;
        --gray-200: #475569;
        --gray-300: #64748b;
        --gray-400: #94a3b8;
        --gray-500: #cbd5e1;
        --gray-600: #e2e8f0;
        --gray-700: #f1f5f9;
        --gray-800: #f8fafc;
        --white: #1e293b;
      }
    }
  </style>
</head>
<body data-auto-load-components="true"> 

  <div id="header-container"></div> 

  <div class="admin-container">
    <div id="sidebar-container"></div> 
    
    <main class="admin-main">
      <!-- পেজ হেডার -->
      <div class="page-header">
        <h1>লাইভ সিরিয়াল ম্যানেজমেন্ট</h1>
        <div class="subtitle">রিয়েল-টাইম সিরিয়াল ট্র্যাকিং এবং ম্যানেজমেন্ট</div>
      </div>
      
      <!-- ড্যাশবোর্ড স্ট্যাটস -->
      <div class="stats-grid">
        <div class="stat-card called-apps">
          <div class="stat-header">
            <div class="stat-title">কল করা হয়েছে</div>
            <div class="stat-icon"><i class="fas fa-phone"></i></div>
          </div>
          <div class="stat-value" id="called-count">০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ১২%</div>
        </div>
        
        <div class="stat-card not-called-apps">
          <div class="stat-header">
            <div class="stat-title">কল করা হয় নি</div>
            <div class="stat-icon"><i class="fas fa-phone-slash"></i></div>
          </div>
          <div class="stat-value" id="not-called-count">০</div>
          <div class="stat-trend negative"><i class="fas fa-arrow-down"></i> ৮%</div>
        </div>
        
        <div class="stat-card token-given-apps">
          <div class="stat-header">
            <div class="stat-title">টোকেন দেওয়া হয়েছে</div>
            <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
          </div>
          <div class="stat-value" id="token-given-count">০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ১৫%</div>
        </div>
        
        <div class="stat-card token-not-given-apps">
          <div class="stat-header">
            <div class="stat-title">টোকেন দেওয়া হয় নি</div>
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
          </div>
          <div class="stat-value" id="token-not-given-count">০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ১০%</div>
        </div>
        
        <div class="stat-card thursday">
          <div class="stat-header">
            <div class="stat-title">বৃহস্পতিবার</div>
            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="stat-value" id="thursdayAppointments">০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ৫%</div>
        </div>
        
        <div class="stat-card friday">
          <div class="stat-header">
            <div class="stat-title">শুক্রবার</div>
            <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
          </div>
          <div class="stat-value" id="fridayAppointments">০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ৭%</div>
        </div>
        
        <div class="stat-card total-appointments">
          <div class="stat-header">
            <div class="stat-title">মোট এপয়েন্টমেন্ট</div>
            <div class="stat-icon"><i class="fas fa-users"></i></div>
          </div>
          <div class="stat-value" id="totalAppointments">০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ২০%</div>
        </div>
        
        <div class="stat-card pending">
          <div class="stat-header">
            <div class="stat-title">পেন্ডিং সিরিয়াল</div>
            <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
          </div>
          <div class="stat-value" id="pendingSerials">০</div>
          <div class="stat-trend negative"><i class="fas fa-arrow-down"></i> ৩%</div>
        </div>
        
        <div class="stat-card total">
          <div class="stat-header">
            <div class="stat-title">মোট সিরিয়াল স্লট</div>
            <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
          </div>
          <div class="stat-value" id="totalSerials">৫০০</div>
          <div class="stat-trend">—</div>
        </div>
        
        <div class="stat-card available">
          <div class="stat-header">
            <div class="stat-title">মোট এভেইলেবল</div>
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="stat-value" id="availableSerials">৫০০</div>
          <div class="stat-trend positive"><i class="fas fa-arrow-up"></i> ২%</div>
        </div>
        
        <div class="stat-card new-call">
          <div class="stat-header">
            <div class="stat-title">নতুন রোগী শেষ কল</div>
            <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
          </div>
          <div class="stat-value" id="newPatientLastCall">০</div>
          <div class="stat-trend">—</div>
        </div>
        
        <div class="stat-card old-call">
          <div class="stat-header">
            <div class="stat-title">পুরাতন রোগী শেষ কল</div>
            <div class="stat-icon"><i class="fas fa-user-check"></i></div>
          </div>
          <div class="stat-value" id="oldPatientLastCall">০</div>
          <div class="stat-trend">—</div>
        </div>
      </div>
      
      <!-- ফিল্টার সেকশন -->
      <div class="section filter-section">
        <div class="section-title">
          <i class="fas fa-filter"></i>
          ফিল্টার অ্যাপয়েন্টমেন্ট
        </div>
        
        <div class="filter-grid">
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-calendar"></i>
              দিন
            </label>
            <select class="filter-select" id="dayFilter">
              <option value="all">সকল দিন</option>
              <option value="Thursday">বৃহস্পতিবার</option>
              <option value="Friday">শুক্রবার</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-user-tag"></i>
              রোগীর ধরন
            </label>
            <select class="filter-select" id="typeFilter">
              <option value="all">সকল ধরন</option>
              <option value="new">নতুন রোগী</option>
              <option value="old">পুরাতন রোগী</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-clock"></i>
              সময়
            </label>
            <select class="filter-select" id="timeFilter">
              <option value="all">সকল সময়</option>
            </select>
          </div>
        </div>
        
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-phone"></i>
              কল স্ট্যাটাস
            </label>
            <select class="filter-select" id="callStatusFilter">
              <option value="all">সকল স্ট্যাটাস</option>
              <option value="called">কল করা হয়েছে</option>
              <option value="not_called">কল করা হয়নি</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-ticket-alt"></i>
              টোকেন স্ট্যাটাস
            </label>
            <select class="filter-select" id="tokenStatusFilter">
              <option value="all">সকল স্ট্যাটাস</option>
              <option value="given">টোকেন দেওয়া হয়েছে</option>
              <option value="not_given">টোকেন দেওয়া হয়নি</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-search"></i>
              সার্চ
            </label>
            <div class="search-container">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="filter-input search-input" id="searchInput" placeholder="নাম, ফোন বা সিরিয়াল দিয়ে খুঁজুন...">
            </div>
          </div>
        </div>
        
        <div class="filter-actions">
          <div class="stats-summary" id="statsSummary">
            মোট বুকিং (ফিল্টার অনুযায়ী): <span id="filteredCount">০</span> টি | প্রদর্শিত: <span id="displayedCount">০</span> টি
          </div>
          
          <button class="add-serial-btn" id="openAddSerialModalBtn">
            <i class="fas fa-plus-circle"></i>
            সিরিয়াল যুক্ত করুন
          </button>
        </div>
      </div>
      
      <!-- ডেটা টেবিল -->
      <div class="section data-section">
        <div class="section-title">
          <i class="fas fa-table"></i>
          সকল অ্যাপয়েন্টমেন্ট
        </div>
        
        <div class="table-container" id="tableContainer">
          <table id="appointmentsTable">
            <thead>
              <tr>
                <th>সিরিয়াল</th>
                <th>কল স্ট্যাটাস</th>
                <th>টোকেন স্ট্যাটাস</th>
                <th>রোগীর নাম</th>
                <th>বয়স</th>
                <th>ফোন</th>
                <th>দিন/সময়</th>
                <th>বুকিং তারিখ</th>
                <th>কল অ্যাকশন</th>
                <th>টোকেন অ্যাকশন</th>
              </tr>
            </thead>
            <tbody id="appointmentsBody">
              <!-- ডেটা ডায়নামিকভাবে যোগ হবে -->
            </tbody>
          </table>
          
          <div class="loading-state" id="loadingState">
            <i class="fas fa-spinner fa-spin"></i>
            <p>ডেটা লোড হচ্ছে...</p>
          </div>
          
          <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>কোনো ডেটা পাওয়া যায়নি</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="footer-container"></div>
  
  <!-- কুইক সিরিয়াল মোডাল -->
  <div class="modal" id="quickSerialModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-plus-circle"></i> সিরিয়াল যুক্ত করুন</h2>
        <button class="close-btn" id="closeQuickModal">&times;</button>
      </div>
      
      <form id="quickSerialForm">
        <div class="form-group">
          <label class="form-label">দিন <span class="required">*</span></label>
          <select class="form-control" id="quickDay" required>
            <option value="">দিন নির্বাচন করুন</option>
            <option value="Thursday">বৃহস্পতিবার</option>
            <option value="Friday">শুক্রবার</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">সময় <span class="required">*</span></label>
          <select class="form-control" id="quickTime" required>
            <option value="">সময় নির্বাচন করুন</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">রোগীর ধরন <span class="required">*</span></label>
          <div class="patient-type-selector">
            <div class="patient-type-card selected" data-type="new">
              <h4>নতুন রোগী</h4>
              <p>প্রথমবারের মতো ভিজিট</p>
            </div>
            <div class="patient-type-card" data-type="old">
              <h4>পুরাতন রোগী</h4>
              <p>পূর্বে ভিজিট করেছেন</p>
            </div>
          </div>
          <input type="hidden" id="selectedPatientType" value="new">
        </div>
        
        <div class="form-group">
          <label class="form-label">সিরিয়াল নির্বাচন করুন <span class="required">*</span></label>
          <div class="serial-grid" id="serialGrid">
            <!-- সিরিয়াল আইটেমগুলি ডায়নামিকভাবে যোগ হবে -->
          </div>
          <input type="hidden" id="selectedSerialNumber" value="">
          <small style="color: var(--gray-500); font-size: 12px; display: block; margin-top: 8px;">
            খালি সিরিয়ালে ক্লিক করে নির্বাচন করুন
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">রোগীর নাম <span class="required">*</span></label>
          <input type="text" class="form-control" id="quickName" required placeholder="রোগীর পূর্ণ নাম লিখুন">
        </div>
        
        <div class="form-group">
          <label class="form-label">বয়স <span class="required">*</span></label>
          <div class="age-fields">
            <div>
              <input type="number" class="form-control" id="quickAgeYears" min="0" max="120" placeholder="বছর">
            </div>
            <div>
              <input type="number" class="form-control" id="quickAgeMonths" min="0" max="11" placeholder="মাস">
            </div>
            <div>
              <input type="number" class="form-control" id="quickAgeDays" min="0" max="30" placeholder="দিন">
            </div>
          </div>
          <small style="color: var(--gray-500); font-size: 12px; display: block; margin-top: 8px;">
            কমপক্ষে একটি ফিল্ড পূরণ করুন
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">ফোন নম্বর (ঐচ্ছিক)</label>
          <input type="tel" class="form-control" id="quickPhone" placeholder="01XXXXXXXXX">
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="cancelQuickModal">
            <i class="fas fa-times"></i>
            বাতিল
          </button>
          <button type="submit" class="btn-submit" id="submitQuickBtn">
            <i class="fas fa-check"></i>
            সিরিয়াল যুক্ত করুন
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // =======================================================
    // ১. কনফিগারেশন এবং ইনিশিয়ালাইজেশন
    // =======================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    let db;
    let allAppointmentsSnapshot = null;
    let serialRanges = {}; // সিরিয়াল রেঞ্জ ডেটা

    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore(app);
      console.log("✅ Firebase initialized successfully");
    } catch (e) {
      console.error("❌ Firebase initialization error:", e);
      showAlert('Firebase সংযোগে সমস্যা হয়েছে', 'error');
    }

    // =======================================================
    // ২. ইউটিলিটি ফাংশন
    // =======================================================
    const toBengaliNumber = (num) => {
      if (num === null || num === undefined || num === '' || isNaN(num)) return '—';
      const numStr = String(Math.floor(num)); 
      const bengaliMap = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
      return numStr.replace(/\d/g, digit => bengaliMap[digit]);
    };

    const formatTimestamp = (timestamp) => {
      if (!timestamp || !timestamp.toDate) return '—';
      try {
        const date = timestamp.toDate();
        return date.toLocaleString('bn-BD', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
          hour12: true
        }).replace(/\d/g, (d) => ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'][d]);
      } catch (e) {
        return '—';
      }
    };

    const getAgeDisplay = (data) => {
      let display = '';
      
      if (data.ageYears || data.ageMonths || data.ageDays) {
        const years = data.ageYears || 0;
        const months = data.ageMonths || 0;
        const days = data.ageDays || 0;
        
        if (years > 0) display += toBengaliNumber(years) + ' বছর';
        if (months > 0) {
          if (display) display += ', ';
          display += toBengaliNumber(months) + ' মাস';
        }
        if (days > 0) {
          if (display) display += ', ';
          display += toBengaliNumber(days) + ' দিন';
        }
      } else if (data.age) {
        if (typeof data.age === 'number') {
          display = toBengaliNumber(data.age) + ' বছর';
        } else if (typeof data.age === 'string') {
          display = data.age;
        }
      }
      
      return display || '—';
    };

    const showAlert = (message, type = 'info') => {
      const alert = document.createElement('div');
      alert.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 3000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      
      if (type === 'success') {
        alert.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      } else if (type === 'error') {
        alert.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
      } else if (type === 'warning') {
        alert.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
      } else {
        alert.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
      }
      
      alert.textContent = message;
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alert.remove(), 300);
      }, 3000);
    };

    // =======================================================
    // ৩. সিরিয়াল রেঞ্জ লোড করা
    // =======================================================
    async function loadSerialRanges() {
      try {
        const rangesRef = db.collection('serialRanges');
        const snapshot = await rangesRef.get();
        
        serialRanges = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          serialRanges[doc.id] = data;
        });
        
        console.log('✅ Serial ranges loaded:', serialRanges);
        return true;
      } catch (error) {
        console.error('❌ Error loading serial ranges:', error);
        showAlert('সিরিয়াল রেঞ্জ লোড করতে সমস্যা হয়েছে', 'error');
        return false;
      }
    }

    // =======================================================
    // ৪. ড্যাশবোর্ড স্ট্যাটস আপডেট
    // =======================================================
    function updateDashboardStats(snapshot) {
      let stats = {
        total: 0,
        thursday: 0,
        friday: 0,
        called: 0,
        notCalled: 0,
        tokenGiven: 0,
        tokenNotGiven: 0,
        newPatients: 0,
        oldPatients: 0,
        lastNewCall: 0,
        lastOldCall: 0
      };
      
      snapshot.forEach(doc => {
        const data = doc.data();
        stats.total++;
        
        // দিন অনুযায়ী
        if (data.day === 'Thursday') stats.thursday++;
        if (data.day === 'Friday') stats.friday++;
        
        // কল স্ট্যাটাস
        if (data.called === true) stats.called++;
        else stats.notCalled++;
        
        // টোকেন স্ট্যাটাস
        if (data.tokenGiven === true) stats.tokenGiven++;
        else stats.tokenNotGiven++;
        
        // রোগীর ধরন
        const type = data.patientType || data.type || 'new';
        if (type === 'new') {
          stats.newPatients++;
          stats.lastNewCall = Math.max(stats.lastNewCall, data.serial || 0);
        } else {
          stats.oldPatients++;
          stats.lastOldCall = Math.max(stats.lastOldCall, data.serial || 0);
        }
      });
      
      // কার্ড আপডেট
      document.getElementById('called-count').textContent = toBengaliNumber(stats.called);
      document.getElementById('not-called-count').textContent = toBengaliNumber(stats.notCalled);
      document.getElementById('token-given-count').textContent = toBengaliNumber(stats.tokenGiven);
      document.getElementById('token-not-given-count').textContent = toBengaliNumber(stats.tokenNotGiven);
      document.getElementById('thursdayAppointments').textContent = toBengaliNumber(stats.thursday);
      document.getElementById('fridayAppointments').textContent = toBengaliNumber(stats.friday);
      document.getElementById('totalAppointments').textContent = toBengaliNumber(stats.total);
      document.getElementById('newPatientLastCall').textContent = toBengaliNumber(stats.lastNewCall);
      document.getElementById('oldPatientLastCall').textContent = toBengaliNumber(stats.lastOldCall);
      
      // অন্যান্য ক্যালকুলেশন
      document.getElementById('availableSerials').textContent = toBengaliNumber(500 - stats.total);
      document.getElementById('pendingSerials').textContent = toBengaliNumber(Math.floor(stats.total * 0.1));
      
      return stats;
    }

    // =======================================================
    // ৫. টাইম ফিল্টার অপশন আপডেট
    // =======================================================
    function updateTimeFilterOptions() {
      const dayFilter = document.getElementById('dayFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const timeSelect = document.getElementById('timeFilter');
      
      if (!allAppointmentsSnapshot) return;
      
      const uniqueTimes = new Set();
      
      allAppointmentsSnapshot.forEach(doc => {
        const data = doc.data();
        
        // দিন ফিল্টার
        if (dayFilter !== 'all' && data.day !== dayFilter) return;
        
        // ধরন ফিল্টার
        if (typeFilter !== 'all') {
          const type = data.patientType || data.type || 'new';
          if (type !== typeFilter) return;
        }
        
        if (data.time) uniqueTimes.add(data.time);
      });
      
      // সময় সাজানো
      const sortedTimes = Array.from(uniqueTimes).sort((a, b) => {
        try {
          const timeA = convertTo24Hour(a);
          const timeB = convertTo24Hour(b);
          return timeA.localeCompare(timeB);
        } catch (e) {
          return a.localeCompare(b);
        }
      });
      
      const currentValue = timeSelect.value;
      timeSelect.innerHTML = '<option value="all">সকল সময়</option>';
      
      sortedTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        if (time === currentValue) option.selected = true;
        timeSelect.appendChild(option);
      });
    }
    
    function convertTo24Hour(timeStr) {
      if (!timeStr) return '';
      
      const [time, modifier] = timeStr.split(' ');
      let [hours, minutes] = time.split(':');
      
      if (modifier === 'PM' && hours !== '12') {
        hours = parseInt(hours, 10) + 12;
      }
      if (modifier === 'AM' && hours === '12') {
        hours = '00';
      }
      
      return `${hours.toString().padStart(2, '0')}:${minutes}`;
    }

    // =======================================================
    // ৬. অ্যাপয়েন্টমেন্ট ফিল্টার এবং রেন্ডার
    // =======================================================
    function filterAndRenderAppointments() {
      if (!allAppointmentsSnapshot) {
        showEmptyState();
        return;
      }
      
      // ফিল্টার মান
      const dayFilter = document.getElementById('dayFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const timeFilter = document.getElementById('timeFilter').value;
      const callStatusFilter = document.getElementById('callStatusFilter').value;
      const tokenStatusFilter = document.getElementById('tokenStatusFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      
      let filteredData = [];
      let totalFiltered = 0;
      
      // ফিল্টার প্রয়োগ
      allAppointmentsSnapshot.forEach(doc => {
        const data = doc.data();
        let passesFilter = true;
        
        // প্রাইমারি ফিল্টার (দিন, ধরন, সময়)
        if (dayFilter !== 'all' && data.day !== dayFilter) passesFilter = false;
        if (passesFilter && typeFilter !== 'all') {
          const type = data.patientType || data.type || 'new';
          if (type !== typeFilter) passesFilter = false;
        }
        if (passesFilter && timeFilter !== 'all' && data.time !== timeFilter) passesFilter = false;
        
        if (passesFilter) totalFiltered++;
        
        // সেকেন্ডারি ফিল্টার (স্ট্যাটাস)
        if (passesFilter && callStatusFilter !== 'all') {
          const isCalled = data.called === true;
          if ((callStatusFilter === 'called' && !isCalled) ||
              (callStatusFilter === 'not_called' && isCalled)) {
            passesFilter = false;
          }
        }
        
        if (passesFilter && tokenStatusFilter !== 'all') {
          const isTokenGiven = data.tokenGiven === true;
          if ((tokenStatusFilter === 'given' && !isTokenGiven) ||
              (tokenStatusFilter === 'not_given' && isTokenGiven)) {
            passesFilter = false;
          }
        }
        
        // সার্চ ফিল্টার
        if (passesFilter && searchTerm) {
          const name = (data.name || '').toLowerCase();
          const phone = String(data.phone || '');
          const serial = String(data.serial || '');
          
          if (!name.includes(searchTerm) && 
              !phone.includes(searchTerm) && 
              !serial.includes(searchTerm)) {
            passesFilter = false;
          }
        }
        
        if (passesFilter) {
          filteredData.push({ id: doc.id, data: data });
        }
      });
      
      // স্ট্যাটাস বার্তা আপডেট
      document.getElementById('filteredCount').textContent = toBengaliNumber(totalFiltered);
      document.getElementById('displayedCount').textContent = toBengaliNumber(filteredData.length);
      
      // টেবিল রেন্ডার
      renderAppointmentsTable(filteredData);
    }
    
    function renderAppointmentsTable(appointments) {
      const tbody = document.getElementById('appointmentsBody');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      
      if (appointments.length === 0) {
        tbody.innerHTML = '';
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      loadingState.style.display = 'none';
      emptyState.style.display = 'none';
      
      tbody.innerHTML = '';
      
      appointments.forEach(item => {
        const { id, data } = item;
        const row = tbody.insertRow();
        
        // স্ট্যাটাস নির্ধারণ
        const isCalled = data.called === true;
        const callStatusClass = isCalled ? 'status-called' : 'status-not-called';
        const callStatusText = isCalled ? 'কল করা হয়েছে' : 'কল করা হয়নি';
        const callButtonClass = isCalled ? 'btn-call-undo' : 'btn-call';
        const callButtonText = isCalled ? 'কল বাতিল করুন' : 'কল করুন';
        const callIcon = isCalled ? 'fa-phone-slash' : 'fa-phone';
        
        const isTokenGiven = data.tokenGiven === true;
        const tokenStatusClass = isTokenGiven ? 'status-token-given' : 'status-token-not-given';
        const tokenStatusText = isTokenGiven ? 'টোকেন দেওয়া' : 'টোকেন বাকি';
        const tokenButtonClass = isTokenGiven ? 'btn-token-undo' : 'btn-token';
        const tokenButtonText = isTokenGiven ? 'টোকেন বাতিল করুন' : 'টোকেন দিন';
        const tokenIcon = isTokenGiven ? 'fa-times' : 'fa-check';
        
        const ageDisplay = getAgeDisplay(data);
        const typeText = (data.patientType || data.type) === 'old' ? 'পুরাতন' : 'নতুন';
        const typeIcon = typeText === 'পুরাতন' ? 'fa-user-check' : 'fa-user-plus';
        
        row.innerHTML = `
          <td>
            <div style="font-weight: 700; color: var(--primary);">${toBengaliNumber(data.serial || '—')}</div>
          </td>
          <td>
            <span class="status-badge ${callStatusClass}">
              <i class="fas ${isCalled ? 'fa-check' : 'fa-clock'}"></i>
              ${callStatusText}
            </span>
          </td>
          <td>
            <span class="status-badge ${tokenStatusClass}">
              <i class="fas ${isTokenGiven ? 'fa-ticket-alt' : 'fa-clock'}"></i>
              ${tokenStatusText}
            </span>
          </td>
          <td>
            <div style="font-weight: 600;">${data.name || '—'}</div>
            <div style="font-size: 12px; color: var(--gray-500);">
              <i class="fas ${typeIcon}"></i> ${typeText}
            </div>
          </td>
          <td>${ageDisplay}</td>
          <td>${data.phone ? toBengaliNumber(data.phone) : 'N/A'}</td>
          <td>
            <div style="font-weight: 600;">${data.day || '—'}</div>
            <div style="font-size: 12px; color: var(--gray-500);">${data.time || '—'}</div>
          </td>
          <td>
            <div style="font-size: 13px;">${formatTimestamp(data.timestamp)}</div>
          </td>
          <td>
            <button class="action-btn ${callButtonClass}" data-id="${id}" data-field="called" data-status="${isCalled}">
              <i class="fas ${callIcon}"></i>
              ${callButtonText}
            </button>
          </td>
          <td>
            <button class="action-btn ${tokenButtonClass}" data-id="${id}" data-field="tokenGiven" data-status="${isTokenGiven}">
              <i class="fas ${tokenIcon}"></i>
              ${tokenButtonText}
            </button>
          </td>
        `;
        
        // ইভেন্ট লিসেনার যোগ
        row.querySelectorAll('.action-btn').forEach(btn => {
          btn.addEventListener('click', handleActionButtonClick);
        });
      });
    }
    
    function showEmptyState() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }

    // =======================================================
    // ৭. অ্যাকশন বাটন হ্যান্ডলার
    // =======================================================
    async function handleActionButtonClick(event) {
      const button = event.currentTarget;
      const docId = button.getAttribute('data-id');
      const field = button.getAttribute('data-field');
      const currentStatus = button.getAttribute('data-status') === 'true';
      const newStatus = !currentStatus;
      
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> আপডেট হচ্ছে...';
      
      try {
        await db.collection('appointments').doc(docId).update({
          [field]: newStatus
        });
        
        showAlert('স্ট্যাটাস সফলভাবে আপডেট হয়েছে', 'success');
        
        // বাটন টেক্সট আপডেট
        setTimeout(() => {
          if (field === 'called') {
            if (newStatus) {
              button.innerHTML = '<i class="fas fa-phone-slash"></i> কল বাতিল করুন';
              button.className = 'action-btn btn-call-undo';
            } else {
              button.innerHTML = '<i class="fas fa-phone"></i> কল করুন';
              button.className = 'action-btn btn-call';
            }
          } else if (field === 'tokenGiven') {
            if (newStatus) {
              button.innerHTML = '<i class="fas fa-times"></i> টোকেন বাতিল করুন';
              button.className = 'action-btn btn-token-undo';
            } else {
              button.innerHTML = '<i class="fas fa-check"></i> টোকেন দিন';
              button.className = 'action-btn btn-token';
            }
          }
          
          button.setAttribute('data-status', newStatus);
          button.disabled = false;
        }, 1000);
        
      } catch (error) {
        console.error('❌ Error updating status:', error);
        showAlert('স্ট্যাটাস আপডেটে সমস্যা হয়েছে', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // =======================================================
    // ৮. কুইক সিরিয়াল ম্যানেজমেন্ট
    // =======================================================
    function initializeQuickSerialModal() {
      const modal = document.getElementById('quickSerialModal');
      const openBtn = document.getElementById('openAddSerialModalBtn');
      const closeBtn = document.getElementById('closeQuickModal');
      const cancelBtn = document.getElementById('cancelQuickModal');
      const form = document.getElementById('quickSerialForm');
      const patientTypeCards = document.querySelectorAll('.patient-type-card');
      const quickDay = document.getElementById('quickDay');
      const quickTime = document.getElementById('quickTime');
      
      // মোডাল ওপেন/ক্লোজ
      openBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
        updateQuickTimeOptions();
      });
      
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        resetQuickSerialForm();
      });
      
      cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        resetQuickSerialForm();
      });
      
      // রোগীর ধরন সিলেকশন
      patientTypeCards.forEach(card => {
        card.addEventListener('click', () => {
          patientTypeCards.forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          document.getElementById('selectedPatientType').value = card.getAttribute('data-type');
          updateQuickSerialGrid();
        });
      });
      
      // দিন পরিবর্তনে সময় অপশন আপডেট
      quickDay.addEventListener('change', updateQuickTimeOptions);
      
      // সময় পরিবর্তনে সিরিয়াল গ্রিড আপডেট
      quickTime.addEventListener('change', updateQuickSerialGrid);
      
      // ফর্ম সাবমিট
      form.addEventListener('submit', handleQuickSerialSubmit);
      
      // মোডাল বাইরে ক্লিক করলে বন্ধ
      window.addEventListener('click', (event) => {
        if (event.target === modal) {
          modal.style.display = 'none';
          resetQuickSerialForm();
        }
      });
    }
    
    function updateQuickTimeOptions() {
      const day = document.getElementById('quickDay').value;
      const timeSelect = document.getElementById('quickTime');
      
      if (!day) {
        timeSelect.innerHTML = '<option value="">প্রথমে দিন নির্বাচন করুন</option>';
        document.getElementById('serialGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray-500);">প্রথমে দিন নির্বাচন করুন</div>';
        return;
      }
      
      // ডেমো সময় অপশন - আপনার ডেটাবেজ থেকে আসবে
      const demoTimes = {
        'Thursday': ['সকাল ৯:০০', 'সকাল ১০:৩০', 'বিকাল ২:০০', 'বিকাল ৪:০০'],
        'Friday': ['সকাল ৯:৩০', 'সকাল ১১:০০', 'বিকাল ৩:০০', 'বিকাল ৫:০০']
      };
      
      const times = demoTimes[day] || [];
      
      timeSelect.innerHTML = '<option value="">সময় নির্বাচন করুন</option>';
      times.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        timeSelect.appendChild(option);
      });
      
      updateQuickSerialGrid();
    }
    
    function updateQuickSerialGrid() {
      const day = document.getElementById('quickDay').value;
      const time = document.getElementById('quickTime').value;
      const type = document.getElementById('selectedPatientType').value;
      const grid = document.getElementById('serialGrid');
      
      if (!day || !time) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray-500);">দিন এবং সময় নির্বাচন করুন</div>';
        return;
      }
      
      grid.innerHTML = '';
      
      // সিরিয়াল রেঞ্জ নির্ধারণ
      let start = 1;
      let end = 30;
      
      if (serialRanges[day] && serialRanges[day][type] && serialRanges[day][type][time]) {
        const range = serialRanges[day][type][time];
        start = range.start || 1;
        end = range.end || 30;
      }
      
      // বুকড সিরিয়াল ডেটা (রিয়েল ডেটা হলে Firebase থেকে আসবে)
      const bookedSerials = getBookedSerials(day, time, type);
      
      // সিরিয়াল গ্রিড তৈরি
      for (let serial = start; serial <= end; serial++) {
        const item = document.createElement('div');
        item.className = 'serial-item';
        item.textContent = serial;
        item.setAttribute('data-serial', serial);
        
        if (bookedSerials.includes(serial)) {
          item.classList.add('booked');
          item.title = 'ইতিমধ্যে বুক করা হয়েছে';
        } else {
          item.addEventListener('click', () => selectSerial(serial));
        }
        
        grid.appendChild(item);
      }
    }
    
    function getBookedSerials(day, time, type) {
      // ডেমো ডেটা - রিয়েল ডেটার জন্য Firebase কুয়েরি করতে হবে
      const demoBooked = {
        'Thursday': {
          'সকাল ৯:০০': { 'new': [3, 7, 12], 'old': [2, 8] },
          'সকাল ১০:৩০': { 'new': [5, 10], 'old': [4, 9] }
        },
        'Friday': {
          'সকাল ৯:৩০': { 'new': [2, 6, 11], 'old': [3, 7] },
          'সকাল ১১:০০': { 'new': [4, 8], 'old': [5, 9] }
        }
      };
      
      return demoBooked[day]?.[time]?.[type] || [];
    }
    
    function selectSerial(serial) {
      const gridItems = document.querySelectorAll('.serial-item');
      gridItems.forEach(item => {
        item.classList.remove('selected');
      });
      
      const selectedItem = document.querySelector(`.serial-item[data-serial="${serial}"]`);
      if (selectedItem && !selectedItem.classList.contains('booked')) {
        selectedItem.classList.add('selected');
        document.getElementById('selectedSerialNumber').value = serial;
      }
    }
    
    function resetQuickSerialForm() {
      document.getElementById('quickSerialForm').reset();
      document.getElementById('selectedSerialNumber').value = '';
      document.getElementById('serialGrid').innerHTML = '';
      document.querySelectorAll('.patient-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector('.patient-type-card[data-type="new"]').classList.add('selected');
      document.getElementById('selectedPatientType').value = 'new';
    }
    
    async function handleQuickSerialSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitQuickBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> যুক্ত করা হচ্ছে...';
      
      try {
        // ফর্ম ডেটা সংগ্রহ
        const formData = {
          name: document.getElementById('quickName').value.trim(),
          day: document.getElementById('quickDay').value,
          time: document.getElementById('quickTime').value,
          patientType: document.getElementById('selectedPatientType').value,
          serial: parseInt(document.getElementById('selectedSerialNumber').value),
          ageYears: parseInt(document.getElementById('quickAgeYears').value) || 0,
          ageMonths: parseInt(document.getElementById('quickAgeMonths').value) || 0,
          ageDays: parseInt(document.getElementById('quickAgeDays').value) || 0,
          phone: document.getElementById('quickPhone').value.trim() || null
        };
        
        // ভ্যালিডেশন
        if (!formData.name) {
          throw new Error('রোগীর নাম প্রয়োজন');
        }
        
        if (!formData.day || !formData.time) {
          throw new Error('দিন এবং সময় নির্বাচন করুন');
        }
        
        if (!formData.serial) {
          throw new Error('সিরিয়াল নির্বাচন করুন');
        }
        
        if (formData.ageYears === 0 && formData.ageMonths === 0 && formData.ageDays === 0) {
          throw new Error('বয়স দিন');
        }
        
        // বয়স স্ট্রিং তৈরি
        let ageString = '';
        if (formData.ageYears > 0) ageString += formData.ageYears + ' বছর';
        if (formData.ageMonths > 0) {
          if (ageString) ageString += ', ';
          ageString += formData.ageMonths + ' মাস';
        }
        if (formData.ageDays > 0) {
          if (ageString) ageString += ', ';
          ageString += formData.ageDays + ' দিন';
        }
        
        // অ্যাপয়েন্টমেন্ট ডেটা
        const appointmentData = {
          name: formData.name,
          age: ageString,
          ageYears: formData.ageYears,
          ageMonths: formData.ageMonths,
          ageDays: formData.ageDays,
          phone: formData.phone,
          day: formData.day,
          time: formData.time,
          patientType: formData.patientType,
          type: formData.patientType,
          serial: formData.serial,
          called: false,
          tokenGiven: false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          bookedBy: 'admin'
        };
        
        // Firebase এ সেভ
        await db.collection('appointments').add(appointmentData);
        
        // সফল মেসেজ
        showAlert(`সিরিয়াল #${formData.serial} সফলভাবে যুক্ত হয়েছে!`, 'success');
        
        // ফর্ম রিসেট এবং মোডাল বন্ধ
        resetQuickSerialForm();
        document.getElementById('quickSerialModal').style.display = 'none';
        
      } catch (error) {
        console.error('❌ Error adding serial:', error);
        showAlert(error.message || 'সিরিয়াল যুক্ত করতে সমস্যা হয়েছে', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    // =======================================================
    // ৯. রিয়েল-টাইম লিসেনার সেটআপ
    // =======================================================
    function setupRealtimeListener() {
      if (!db) {
        showAlert('Firebase সংযোগ নেই', 'error');
        return;
      }
      
      const appointmentsRef = db.collection('appointments');
      
      appointmentsRef.orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        console.log('🔄 Realtime update:', snapshot.size, 'documents');
        allAppointmentsSnapshot = snapshot;
        
        // ড্যাশবোর্ড আপডেট
        updateDashboardStats(snapshot);
        
        // ফিল্টার অপশন আপডেট
        updateTimeFilterOptions();
        
        // ডেটা ফিল্টার এবং রেন্ডার
        filterAndRenderAppointments();
        
        // লোডিং স্টেট হাইড
        document.getElementById('loadingState').style.display = 'none';
        
      }, error => {
        console.error('❌ Realtime listener error:', error);
        showAlert('রিয়েল-টাইম ডেটা লোডে সমস্যা হয়েছে', 'error');
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
      });
    }

    // =======================================================
    // ১০. ফিল্টার লিসেনার সেটআপ
    // =======================================================
    function setupFilterListeners() {
      const filters = [
        'dayFilter',
        'typeFilter',
        'timeFilter',
        'callStatusFilter',
        'tokenStatusFilter'
      ];
      
      filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', filterAndRenderAppointments);
      });
      
      document.getElementById('searchInput').addEventListener('input', debounce(filterAndRenderAppointments, 300));
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // =======================================================
    // ১১. ইনিশিয়ালাইজেশন
    // =======================================================
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('🚀 Initializing Live Serial Management...');
      
      // Firebase চেক
      if (!db) {
        showAlert('Firebase সংযোগ নেই', 'error');
        return;
      }
      
      // সিরিয়াল রেঞ্জ লোড
      await loadSerialRanges();
      
      // ফিল্টার লিসেনার সেটআপ
      setupFilterListeners();
      
      // কুইক সিরিয়াল মোডাল সেটআপ
      initializeQuickSerialModal();
      
      // রিয়েল-টাইম লিসেনার শুরু
      setupRealtimeListener();
      
      console.log('✅ Live Serial Management initialized successfully');
      
      // CSS অ্যানিমেশন যোগ
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>